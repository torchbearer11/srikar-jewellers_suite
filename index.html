<!-- <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Srikar Jewellers - Business Suite</title>
    <link rel="icon" type="image/jpeg" href="logo.jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {--gold-primary: #DCCA87;--gold-secondary: #F5EFE1;--dark-bg: #0C0C0C;--dark-secondary: #181818;--text-primary: #FFFFFF;--text-secondary: #AAAAAA;--danger-red: #d9534f; --transition-fast: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); --status-pending: #f0ad4e; --status-progress: #5bc0de; --status-completed: #5cb85c; --status-delivered: #8a6de9;}
        * {margin: 0;padding: 0;box-sizing: border-box;}
        body {font-family: 'Poppins', sans-serif;background-color: var(--dark-bg);color: var(--text-secondary);min-height: 100vh; line-height: 1.6;}
        
        #portalSelectionScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 2rem; background-color: var(--dark-bg); animation: fadeIn 0.8s ease-out; position: relative; z-index: 1; }
        #portalSelectionScreen::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('logo.jpeg'); background-position: center; background-repeat: no-repeat; background-size: 450px; opacity: 0.2; z-index: -1; }
        .container { position: relative; z-index: 1; overflow: hidden; }
        .container::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; height: 95%; background-image: url('logo.jpeg'); background-position: center; background-repeat: no-repeat; background-size: contain; opacity: 0.07; z-index: -1; pointer-events: none; }

        .portal-header { margin-bottom: 3rem; }
        .portal-header h1 { font-family: 'Cormorant Garamond', serif; font-size: 4rem; color: var(--gold-primary); }
        .portal-header p { font-size: 1.2rem; color: var(--text-secondary); }
        .portal-choices { display: flex; flex-wrap: wrap; justify-content: center; gap: 2rem; }
        .portal-card { background: var(--dark-secondary); border: 1px solid rgba(220, 202, 135, 0.15); border-radius: 20px; padding: 3rem 2rem; width: 300px; cursor: pointer; transition: all 0.3s ease; background-color: rgba(24, 24, 24, 0.8); backdrop-filter: blur(5px); }
        .portal-card:hover { transform: translateY(-10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-color: var(--gold-primary); }
        .portal-card i { font-size: 3.5rem; color: var(--gold-primary); margin-bottom: 1.5rem; }
        .portal-card h2 { font-family: 'Cormorant Garamond', serif; font-size: 2rem; color: var(--gold-secondary); margin-bottom: 0.5rem; }
        .portal-card p { color: var(--text-secondary); }

        .app-portal { display: none; }
        .container {max-width: 1800px;margin: 1rem;background: var(--dark-secondary);border: 1px solid rgba(220, 202, 135, 0.15);border-radius: 20px;}
        .header {padding: 2rem 1.5rem;background: #111111;border-bottom: 1px solid rgba(220, 202, 135, 0.15);display: flex;align-items: center;justify-content: space-between;flex-wrap: wrap; gap: 1rem;}
        .header-text h1 {font-family: 'Cormorant Garamond', serif;font-size: 2.5rem;color: var(--gold-primary);}
        
        .logo-container .logo { width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--gold-primary); box-shadow: 0 0 30px rgba(220, 202, 135, 0.6); }
        
        .nav-tabs {background: var(--dark-secondary);padding: 0 1rem;display: flex;border-bottom: 1px solid rgba(220, 202, 135, 0.1);overflow-x: auto;}
        .nav-tabs button {background: transparent;border: none;padding: 1.2rem 1rem;font-size: 1rem;cursor: pointer;color: var(--text-secondary);border-bottom: 3px solid transparent;transition: var(--transition-fast);white-space: nowrap;}
        .nav-tabs button:hover, .nav-tabs button.active {color: var(--gold-primary);}
        .nav-tabs button.active {border-bottom-color: var(--gold-primary);}
        .nav-tabs button i {margin-right: 0.75rem;}
        .tab-content {padding: 1.5rem; display: none;}
        .tab-content.active {display: block; animation: fadeIn 0.6s ease-out;}
        @keyframes fadeIn {from {opacity: 0;transform: translateY(15px);} to {opacity: 1;transform: translateY(0);}}
        .section-title {font-family: 'Cormorant Garamond', serif;font-size: 2.2rem;color: var(--gold-primary);margin-bottom: 2rem;text-align: center;}
        .premium-card {background: #111111;border: 1px solid rgba(220, 202, 135, 0.1);border-radius: 15px;padding: 1.5rem;margin-bottom: 2rem;}
        .form-grid {display: grid;grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));gap: 1.5rem;}
        .form-group {display: flex;flex-direction: column;}
        .form-group label {margin-bottom: 0.75rem;font-weight: 500;color: var(--gold-secondary);font-size: 0.9rem;text-transform: uppercase;}
        .form-group input, .form-group select, .form-group textarea {width: 100%;padding: 0.8rem 1rem;border: 1px solid rgba(220, 202, 135, 0.2);border-radius: 8px;font-size: 1rem;background: var(--dark-secondary);color: var(--text-primary);transition: var(--transition-fast);}
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {outline: none;border-color: var(--gold-primary);}
        .btn {padding: 0.8rem 1.8rem;border: 1px solid var(--gold-primary);border-radius: 8px;cursor: pointer;font-size: 1rem;font-weight: 600;text-transform: uppercase;transition: var(--transition-fast); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .btn-secondary {background: transparent;color: var(--gold-primary);}
        .btn-secondary:hover {background: rgba(220, 202, 135, 0.1);}
        .btn-primary {background: var(--gold-primary);color: var(--dark-bg);}
        .btn-primary:hover {background: #EADCA6;}
        .btn-danger {background: var(--danger-red);color: white;border-color: var(--danger-red);}
        .btn-danger:hover {background: #c9302c;}
        .btn:disabled {background: #555;border-color: #555;color: #888;cursor: not-allowed;}
        .premium-table {width: 100%;border-collapse: collapse;background: #111111;border-radius: 15px;overflow: hidden;}
        .premium-table th, .premium-table td {padding: 1.2rem 1rem;text-align: left;vertical-align: middle; border-bottom: 1px solid rgba(220, 202, 135, 0.1);}
        .premium-table th {background: var(--dark-secondary);color: var(--gold-primary);text-transform: uppercase;}
        .premium-table tbody tr:hover {background: var(--dark-secondary);}
        .order-image-thumbnail {width: 50px; height: 50px; border-radius: 5px; object-fit: cover; cursor: pointer; transition: transform 0.2s ease;}
        .order-image-thumbnail:hover {transform: scale(1.1);}
        .contact-links {display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;}
        .contact-links a {padding: 0.3rem 0.6rem; border-radius: 5px; text-decoration: none; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 0.3rem; transition: var(--transition-fast);}
        .phone-link { background: rgba(92, 184, 230, 0.1); color: #5cb8e6; border: 1px solid rgba(92, 184, 230, 0.3); }
        .phone-link:hover { background: rgba(92, 184, 230, 0.2); }
        .whatsapp-link { background: rgba(37, 211, 102, 0.1); color: #25D366; border: 1px solid rgba(37, 211, 102, 0.3); }
        .whatsapp-link:hover { background: rgba(37, 211, 102, 0.2); }
        .status-badge { padding: 0.3rem 0.7rem; border-radius: 20px; color: white; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; }
        .status-Pending { background-color: var(--status-pending); }
        .status-In-Progress { background-color: var(--status-progress); }
        .status-Completed { background-color: var(--status-completed); }
        .status-Delivered { background-color: var(--status-delivered); }
        .analytics-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .analytics-card { background: #1C1C1C; padding: 1.5rem; border-radius: 10px; text-align: center; border-left: 5px solid var(--gold-primary); }
        .analytics-card h3 { font-size: 2.5rem; color: var(--gold-primary); }
        .analytics-card p { font-size: 1rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .chart-container {height: 350px;padding: 1rem;background: #1C1C1C;border-radius: 10px;}
        .premium-notification {position: fixed;bottom: 20px;left: 50%;transform: translateX(-50%);padding: 1rem 2rem;background: linear-gradient(145deg, #EADCA6 0%, #DCCA87 100%);color: var(--dark-bg);border-radius: 10px;z-index: 9999;font-weight: 600;animation: slideUp 0.5s ease forwards, slideDown 0.5s ease 4.5s forwards;}
        @keyframes slideUp {from {transform: translate(-50%, 150%);} to {transform: translate(-50%, 0);}}
        @keyframes slideDown {from {transform: translate(-50%, 0); opacity: 1;} to {transform: translate(-50%, 150%); opacity: 0;}}
        .modal-premium {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.7);backdrop-filter: blur(10px);z-index: 1000;display: none;align-items: center;justify-content: center;opacity: 0;transition: opacity 0.4s ease;}
        .modal-premium.show {display: flex;opacity: 1;}
        .modal-content {background: var(--dark-secondary);border: 1px solid rgba(220, 202, 135, 0.2);border-radius: 20px;padding: 2rem;width: 95%;max-width: 800px;max-height: 90vh;overflow-y: auto;}
        
        #imageModal .modal-content { max-width: 90vw; max-height: 90vh; padding: 0.5rem; }
        #fullSizeImageContainer { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; height: 100%; }
        #fullSizeImageContainer img { max-width: 100%; max-height: calc(85vh); object-fit: contain; }

        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; align-items: flex-end; }
        .notes-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(220, 202, 135, 0.15); }
        .note-item { background: #111; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 3px solid var(--gold-primary); }
        .note-item p { margin: 0; color: var(--text-primary); }
        .note-item small { color: var(--text-secondary); font-size: 0.8rem; }
        
        .order-items-container { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(220, 202, 135, 0.1); }
        .order-item-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; align-items: flex-end; padding: 1rem; background: #1C1C1C; border-radius: 10px; margin-bottom: 1rem; position: relative; }
        .order-item-row .remove-item-btn { position: absolute; top: 5px; right: 5px; background: transparent; border: none; color: var(--danger-red); cursor: pointer; font-size: 1.2rem; }
        .details-row { display: none; }
        .details-row.show { display: table-row; background: #0A0A0A; }
        .details-row > td { padding: 0 !important; border: 0 !important; }
        .details-content { padding: 1.5rem; }
        .details-content h4 { color: var(--gold-primary); margin-bottom: 1rem; }
        .staff-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #1C1C1C; border-radius: 8px; margin-bottom: 0.5rem; }
        .inline-item-update { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; align-items: center; padding: 0.8rem; background: #1C1C1C; border-radius: 8px; margin-bottom: 0.8rem;}

        @media (max-width: 768px) {
            .portal-header h1 { font-size: 2.5rem; }
            .container { margin: 0; border-radius: 0; }
            .premium-table thead { display: none; }
            .premium-table, .premium-table tbody, .premium-table tr, .premium-table td { display: block; width: 100%; }
            .premium-table tr { margin-bottom: 1rem; border: 1px solid rgba(220, 202, 135, 0.15); border-radius: 10px; padding: 1rem; }
            .premium-table td { padding: 0.75rem 0.5rem; padding-left: 50%; text-align: right; position: relative; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: flex-end; }
            .premium-table td:last-child { border-bottom: none; }
            .premium-table td::before { content: attr(data-label); position: absolute; left: 0.5rem; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: var(--gold-secondary); }
            .inline-item-update { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="portalSelectionScreen">
        <div class="portal-header">
            <h1>Srikar Jewellers</h1>
            <p>Business Suite</p>
        </div>
        <div class="portal-choices">
            <div class="portal-card" onclick="showPortal('crm')">
                <i class="fas fa-users"></i>
                <h2>Insta CRM</h2>
                <p>Manage Customer Leads & Follow-ups</p>
            </div>
            <div class="portal-card" onclick="showPortal('order')">
                <i class="fas fa-gem"></i>
                <h2>Order Management</h2>
                <p>Track Custom Orders & Production</p>
            </div>
             <div class="portal-card" onclick="showPortal('staff')">
                <i class="fas fa-id-card"></i>
                <h2>Staff Management</h2>
                <p>Add or Remove Staff Members</p>
            </div>
        </div>
    </div>

    <div id="crmPortal" class="app-portal">
        <div class="container">
            <header class="header">
                <div class="header-text"><h1>Insta CRM</h1><p>Professional CRM | Bhimavaram</p></div>
                <div class="logo-container"><img src="logo.jpeg" alt="Logo" class="logo"></div>
                <button class="btn btn-secondary" onclick="showPortalSelection()"><i class="fas fa-home"></i> Main Menu</button>
            </header>
            <div class="nav-tabs">
                <button class="tab-button active" onclick="crmApp.showTab('add-customer', this)"><i class="fas fa-plus-circle"></i> Add Customer</button>
                <button class="tab-button" onclick="crmApp.showTab('daily-updates', this)"><i class="fas fa-comments"></i> Daily Updates</button>
                <button class="tab-button" onclick="crmApp.showTab('follow-ups', this)"><i class="fas fa-calendar-check"></i> Follow-ups</button>
                <button class="tab-button" onclick="crmApp.showTab('customer-list', this)"><i class="fas fa-users"></i> Database</button>
                <button class="tab-button" onclick="crmApp.showTab('history', this)"><i class="fas fa-history"></i> Customer History</button>
                <button class="tab-button" onclick="crmApp.showTab('analytics', this)"><i class="fas fa-chart-pie"></i> Analytics</button>
            </div>
            <div id="add-customer" class="tab-content active"><h2 class="section-title">Record New Lead</h2><div class="premium-card"><form id="customerForm"><div class="form-grid"><div class="form-group"><label for="customerName">Customer Name</label><input type="text" id="customerName"></div><div class="form-group"><label for="phoneNumber">Phone Number *</label><input type="tel" id="phoneNumber" required></div><div class="form-group"><label for="email">Email Address</label><input type="email" id="email"></div><div class="form-group"><label for="location">Location</label><input type="text" id="location"></div><div class="form-group"><label for="adSource">Lead Source</label><select id="adSource"><option value="">Select Source</option><option value="Instagram">Instagram</option><option value="Facebook">Facebook</option><option value="Referral">Referral</option><option value="Walk-in">Walk-in</option><option value="Other">Other</option></select></div><div class="form-group"><label for="interestedProduct">Product of Interest</label><input type="text" id="interestedProduct" list="productList"><datalist id="productList"></datalist></div><div class="form-group"><label for="budget">Estimated Budget</label><select id="budget"><option value="">Select Budget</option><option value="<50k">Under ₹50,000</option><option value="50k-1L">₹50k - ₹1 Lakh</option><option value="1L-3L">₹1 Lakh - ₹3 Lakh</option><option value=">5L">Above ₹5 Lakh</option></select></div><div class="form-group"><label for="leadStatus">Initial Status</label><select id="leadStatus"><option value="New">New</option><option value="Contacted">Contacted</option><option value="Interested">Interested</option><option value="Follow-up">Follow-up</option><option value="Not Interested">Not Interested</option></select></div><div class="form-group"><label for="priority">Priority</label><select id="priority"><option value="Medium">Medium</option><option value="High">High</option><option value="Low">Low</option></select></div><div class="form-group"><label for="nextFollowUp">Next Follow-up</label><input type="date" id="nextFollowUp"></div></div><div class="form-group" style="margin-top:1.5rem;"><label for="initialResponse">Notes</label><textarea id="initialResponse" rows="3"></textarea></div><div style="text-align: center; margin-top: 2rem;"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Customer</button></div></form></div></div>
            <div id="daily-updates" class="tab-content"><h2 class="section-title">Daily Customer Updates</h2><div class="premium-card"><h3 style="color: var(--gold-primary); margin-bottom: 1.5rem;"><i class="fas fa-plus-circle"></i> Add Daily Update</h3><form id="dailyUpdateForm"><div class="form-grid"><div class="form-group"><label>Search/Select Customer</label><input type="text" id="dailyUpdateCustomerSearch" list="dailyUpdateCustomerList" placeholder="Start typing name or phone..." required><datalist id="dailyUpdateCustomerList"></datalist><input type="hidden" id="dailyUpdateCustomerId"></div><div class="form-group"><label>Support Person</label><input type="text" id="supportPerson" required></div><div class="form-group"><label>Interaction Type</label><select id="callStatus"><option value="Phone Call">Phone Call</option><option value="WhatsApp">WhatsApp</option><option value="Store Visit">Store Visit</option><option value="Email">Email</option></select></div></div><div class="form-group" style="margin-top: 1rem;"><label>Daily Comment/Update *</label><textarea id="dailyComment" rows="4" required></textarea></div><div style="text-align: center; margin-top: 1.5rem;"><button type="submit" class="btn btn-primary"><i class="fas fa-comment-medical"></i> Add Update</button></div></form></div><div class="premium-card"><h3 style="color: var(--gold-primary); margin-bottom: 1.5rem;"><i class="fas fa-history"></i> Recent Updates</h3><div id="dailyUpdatesList"></div></div></div>
            <div id="follow-ups" class="tab-content"><h2 class="section-title">Follow-up Schedule</h2><div class="form-grid"><div class="premium-card"><h3><i class="fas fa-fire" style="color:#d9534f;"></i> Overdue</h3><div id="overdueFollowUps"></div></div><div class="premium-card"><h3><i class="fas fa-star" style="color:#f0ad4e;"></i> Today</h3><div id="todayFollowUps"></div></div><div class="premium-card"><h3><i class="fas fa-calendar-day" style="color:#5bc0de;"></i> Upcoming</h3><div id="upcomingFollowUps"></div></div></div></div>
            <div id="customer-list" class="tab-content"><h2 class="section-title">Customer Database</h2><div class="premium-card"><div class="form-grid"><div class="form-group"><label>Search by Name/Phone</label><input type="text" id="searchInput" oninput="crmApp.renderAll()"></div><div class="form-group"><label>Filter by Status</label><select id="statusFilter" onchange="crmApp.renderAll()"><option value="">All Statuses</option><option value="New">New</option><option value="Contacted">Contacted</option><option value="Interested">Interested</option><option value="Follow-up">Follow-up</option><option value="Converted">Converted</option><option value="Not Interested">Not Interested</option></select></div><div class="form-group"><label>Filter by Product</label><input type="text" id="productFilter" list="productList" oninput="crmApp.renderAll()" placeholder="Type or select product..."></div></div></div><div class="table-container"><table class="premium-table"><thead id="customerTableHeader"></thead><tbody id="customerTableBody"></tbody></table></div></div>
            <div id="history" class="tab-content"><h2 class="section-title">Full Customer History</h2><div class="premium-card"><div class="form-group"><label>Search Customer by Name or Phone</label><input type="text" id="historySearchInput" list="historyCustomerList" placeholder="Start typing..."><datalist id="historyCustomerList"></datalist></div><div style="text-align:center; margin-top:1rem;"><button class="btn btn-secondary" onclick="crmApp.searchAndDisplayHistory()">Search</button></div></div><div id="customerHistoryLog" class="premium-card" style="display:none;"></div></div>
            <div id="analytics" class="tab-content"><h2 class="section-title">Business Analytics</h2><div class="analytics-dashboard" id="crmAnalyticsDashboard"><div class="analytics-card"><h3 id="totalLeads">0</h3><p>Total Leads</p></div><div class="analytics-card"><h3 id="conversionRate">0%</h3><p>Conversion Rate</p></div><div class="analytics-card"><h3 id="todayUpdates">0</h3><p>Today's Updates</p></div><div class="analytics-card"><h3 id="followUpPending">0</h3><p>Pending Follow-ups</p></div></div><div class="premium-card"><h3 class="section-title" style="font-size: 1.8rem; margin-bottom: 1.5rem;">Customer Count by Lead Source</h3><div id="sourceCountDashboard" class="form-grid"></div></div><div class="form-grid"><div class="premium-card"><h3 class="section-title" style="font-size: 1.5rem;">Lead Sources</h3><div class="chart-container"><canvas id="sourceChart"></canvas></div></div><div class="premium-card"><h3 class="section-title" style="font-size: 1.5rem;">Lead Status</h3><div class="chart-container"><canvas id="statusChart"></canvas></div></div></div></div>
        </div>
        <div id="crmUpdateModal" class="modal-premium"><div class="modal-content"><h2 class="section-title" style="margin-bottom: 1.5rem;">Update Customer & View History</h2><form id="updateForm"><input type="hidden" id="updateCustomerIdModal"><div class="form-grid"><div class="form-group"><label>Customer Name</label><input type="text" id="updateName" required></div><div class="form-group"><label>Phone Number</label><input type="tel" id="updatePhone" required></div><div class="form-group"><label>Email</label><input type="email" id="updateEmail"></div><div class="form-group"><label>Location</label><input type="text" id="updateLocation"></div><div class="form-group"><label>Status</label><select id="updateStatus"><option value="New">New</option><option value="Contacted">Contacted</option><option value="Interested">Interested</option><option value="Follow-up">Follow-up</option><option value="Converted">Converted</option><option value="Not Interested">Not Interested</option></select></div><div class="form-group"><label>Priority</label><select id="updatePriority"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option></select></div><div class="form-group"><label>Next Follow-up Date</label><input type="date" id="updateFollowUp"></div></div><div style="margin-top: 2rem;"><h3 style="color: var(--gold-primary); margin-bottom: 1rem;"><i class="fas fa-history"></i> Recent History</h3><div id="customerUpdateHistory" style="max-height: 300px; overflow-y: auto;"></div></div><div style="text-align: center; margin-top: 2rem; display:flex; gap: 1rem; justify-content:center;"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Update Customer</button><button type="button" class="btn btn-secondary" onclick="crmApp.closeModal()">Cancel</button></div></form></div></div>
    </div>

    <div id="orderPortal" class="app-portal">
        <div class="container">
            <header class="header">
                <div class="header-text"><h1>Order Management</h1><p>Track Custom Orders & Production</p></div>
                <div class="logo-container"><img src="logo.jpeg" alt="Logo" class="logo"></div>
                <button class="btn btn-secondary" onclick="showPortalSelection()"><i class="fas fa-home"></i> Main Menu</button>
            </header>
            <div class="nav-tabs">
                <button class="tab-button active" onclick="orderApp.showTab('new-order', this)"><i class="fas fa-plus-circle"></i> New Order</button>
                <button class="tab-button" onclick="orderApp.showTab('order-tracking', this)"><i class="fas fa-tasks"></i> Order Tracking</button>
                <button class="tab-button" onclick="orderApp.showTab('dashboard', this)"><i class="fas fa-chart-pie"></i> Dashboard</button>
            </div>
            
            <div id="order-new-order" class="tab-content active">
                <h2 class="section-title">Enter New Order Details</h2>
                <div class="premium-card">
                    <form id="newOrderForm">
                        <h3 style="color: var(--gold-secondary); margin-bottom: 1rem; border-bottom: 1px solid var(--gold-primary); padding-bottom: 0.5rem;">Customer Details</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="orderNumber">Order Number</label><input type="number" id="orderNumber" required></div>
                            <div class="form-group"><label for="orderCustomerName">Customer Name</label><input type="text" id="orderCustomerName" required></div>
                            <div class="form-group"><label for="orderPhoneNumber">Phone Number</label><input type="tel" id="orderPhoneNumber" required></div>
                            <div class="form-group"><label for="city">City</label><input type="text" id="city"></div>
                            <div class="form-group"><label for="orderDate">Order Date</label><input type="date" id="orderDate"></div>
                            <div class="form-group"><label for="deliveryDate">Delivery Date</label><input type="date" id="deliveryDate"></div>
                            <div class="form-group"><label for="assignedTo">Overseen By</label><select id="assignedTo" required></select></div>
                        </div>
                        
                        <div class="form-group" style="margin-top:1.5rem;"><label for="specifications">Specifications / Notes</label><textarea id="specifications" rows="3"></textarea></div>
                        <div class="form-group" style="margin-top:1.5rem;"><label for="modifications">Modifications</label><textarea id="modifications" rows="3"></textarea></div>
                        <div class="form-group" style="margin-top:1.5rem;"><label for="itemPictures">Item Pictures</label><input type="file" id="itemPictures" accept="image/*" multiple></div>
                        
                        <div class="order-items-container">
                             <h3 style="color: var(--gold-secondary); margin-bottom: 1rem; border-bottom: 1px solid var(--gold-primary); padding-bottom: 0.5rem;">Order Items</h3>
                            <div id="orderItemsList"></div>
                            <div style="text-align: left; margin-top: 1rem;">
                                <button type="button" class="btn btn-secondary" onclick="orderApp.addOrderItemRow()"><i class="fas fa-plus"></i> Add Item</button>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 2rem;"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Order</button></div>
                    </form>
                </div>
            </div>

            <div id="order-order-tracking" class="tab-content">
                <h2 class="section-title">Track All Orders</h2>
                <div class="premium-card">
                    <div class="filter-grid">
                        <div class="form-group"><label>Search by Order #, Name, Phone</label><input type="text" id="orderSearchInput" oninput="orderApp.renderOrders()"></div>
                        <div class="form-group">
                            <label>Special Filters</label>
                            <select id="specialFilter" onchange="orderApp.renderOrders()">
                                <option value="all">All Active Orders</option>
                                <option value="overdue">Overdue Orders</option>
                                <option value="unassigned">Unassigned Worker</option>
                                <option value="completedNotDelivered">Ready for Delivery</option>
                                <option value="delivered">Delivered Orders</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filter by Staff</label>
                            <select id="staffFilter" onchange="orderApp.renderOrders()">
                                <option value="all">All Staff</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-container"><table class="premium-table"><thead id="orderTableHeader"></thead><tbody id="orderTableBody"></tbody></table></div>
            </div>
            
            <div id="order-dashboard" class="tab-content"><h2 class="section-title">Business Dashboard</h2><div class="analytics-dashboard" id="orderAnalyticsDashboard"><div class="analytics-card"><h3 id="totalOrders">0</h3><p>Total Orders Ever</p></div><div class="analytics-card"><h3 id="pendingOrders">0</h3><p>Pending</p></div><div class="analytics-card"><h3 id="inProgressOrders">0</h3><p>In Progress</p></div><div class="analytics-card"><h3 id="overdueCount">0</h3><p>Overdue</p></div><div class="analytics-card"><h3 id="deliveredCount">0</h3><p>Delivered</p></div></div><div class="premium-card"><h3 class="section-title" style="font-size: 1.8rem;">Orders by Worker</h3><div class="chart-container"><canvas id="workerChart"></canvas></div></div></div>
        </div>
        
        <div id="orderUpdateModal" class="modal-premium"><div class="modal-content"><h2 class="section-title" style="margin-bottom: 1.5rem;">Update Order</h2><form id="updateOrderForm"><input type="hidden" id="updateOrderId"><div id="updateOrderItemsList" class="form-grid" style="margin-bottom: 2rem;"></div><div class="form-grid"><div class="form-group"><label for="updateSpecifications">Specifications</label><textarea id="updateSpecifications" rows="3"></textarea></div><div class="form-group"><label for="updateModifications">Modifications</label><textarea id="updateModifications" rows="3"></textarea></div></div><div style="text-align: center; margin-top: 2rem;"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button></div></form><div class="notes-section"><h3 style="color: var(--gold-primary); margin-bottom: 1.5rem; text-align: center;">Customer Communication Log</h3><div id="customerNotesHistory"></div><div class="form-group"><label for="newCustomerNote">Add New Description</label><textarea id="newCustomerNote" rows="3" placeholder="What to say to the customer..."></textarea></div><div style="text-align: center; margin-top: 1rem;"><button type="button" id="addNoteBtn" class="btn btn-secondary"><i class="fas fa-plus"></i> Add Note</button></div></div></div></div>
        <div id="imageModal" class="modal-premium"><div class="modal-content"><div id="fullSizeImageContainer"></div></div></div>
    </div>

    <div id="staffPortal" class="app-portal">
         <div class="container">
            <header class="header">
                <div class="header-text"><h1>Staff Management</h1><p>Add and Remove Team Members</p></div>
                <div class="logo-container"><img src="logo.jpeg" alt="Logo" class="logo"></div>
                <button class="btn btn-secondary" onclick="showPortalSelection()"><i class="fas fa-home"></i> Main Menu</button>
            </header>
            <div class="tab-content active" style="padding-top: 2rem;">
                 <div class="premium-card">
                    <h2 class="section-title" style="font-size: 1.8rem;">Add New Staff Member</h2>
                    <form id="addStaffForm" style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex-grow: 1;">
                            <label for="newStaffName">Staff Name</label>
                            <input type="text" id="newStaffName" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Staff</button>
                    </form>
                </div>
                 <div class="premium-card">
                    <h2 class="section-title" style="font-size: 1.8rem;">Current Staff</h2>
                    <div id="staffListContainer"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // === GLOBAL UTILITIES (Shared by all apps) ===
        function showNotification(message, isSuccess = true) {
            const notification = document.createElement('div');
            notification.className = 'premium-notification';
            notification.innerHTML = `<i class="fas fa-${isSuccess ? 'check-circle' : 'times-circle'}"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => { if (notification.parentNode) notification.parentNode.removeChild(notification); }, 5000);
        }

        function toggleButtonLoading(button, isLoading, defaultButtonText = '') {
            if(button){ 
                button.disabled = isLoading; 
                if(isLoading) { 
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
                } else if (defaultButtonText) { 
                    button.innerHTML = defaultButtonText; 
                }
            }
        }

        function formatPhoneForWhatsApp(phone) { 
            let cleaned = (phone || '').replace(/\D/g, ''); 
            if (cleaned.length === 10) { cleaned = '91' + cleaned; } 
            return cleaned; 
        }

        // === PORTAL NAVIGATION ===
        const portalSelectionScreen = document.getElementById('portalSelectionScreen');
        const crmPortal = document.getElementById('crmPortal');
        const orderPortal = document.getElementById('orderPortal');
        const staffPortal = document.getElementById('staffPortal');
        
        let isCrmInitialized = false;
        let isOrderInitialized = false;
        let isStaffInitialized = false;

        function showPortal(portalName) {
            portalSelectionScreen.style.display = 'none';
            crmPortal.style.display = 'none';
            orderPortal.style.display = 'none';
            staffPortal.style.display = 'none';

            if (portalName === 'crm') {
                crmPortal.style.display = 'block';
                if (!isCrmInitialized) { crmApp.init(); isCrmInitialized = true; }
            } else if (portalName === 'order') {
                orderPortal.style.display = 'block';
                if (!isOrderInitialized) { orderApp.init(); isOrderInitialized = true; }
            } else if (portalName === 'staff') {
                staffPortal.style.display = 'block';
                if (!isStaffInitialized) { 
                    orderApp.initStaffPortal(); 
                    isStaffInitialized = true; 
                } else {
                    orderApp.renderStaffList();
                }
            }
        }

        function showPortalSelection() {
            crmPortal.style.display = 'none';
            orderPortal.style.display = 'none';
            staffPortal.style.display = 'none';
            portalSelectionScreen.style.display = 'flex';
        }

        // ===================================================================================
        // ================================ INSTA CRM APP ====================================
        // ===================================================================================
        const crmApp = {
            customers: [], dailyUpdates: [], charts: {}, modal: null,
            init() { this.modal = document.getElementById('crmUpdateModal'); this.showTab('add-customer', document.querySelector('#crmPortal .tab-button')); this.loadAllDataFromServer(); this.setupEventListeners(); },
            async handleApiRequest(endpoint, body, successMessage) { try { const response = await fetch(`/.netlify/functions/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); if (!response.ok) { const err = await response.json(); throw new Error(err.message || 'Server request failed'); } if(successMessage) showNotification(successMessage, true); return true; } catch (error) { showNotification(`Error: ${error.message}`, false); return false; } },
            async loadAllDataFromServer() { try { const response = await fetch('/.netlify/functions/get-all-data'); if (!response.ok) throw new Error('Server error!'); const data = await response.json(); this.customers = (data.customers || []).map(c => ({...c, id: c.id})); this.dailyUpdates = (data.dailyUpdates || []).map(u => ({...u, id: u.id})); this.customers.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded)); this.dailyUpdates.sort((a, b) => new Date(b.date) - new Date(a.date)); this.renderAll(); } catch (error) { showNotification("Could not load CRM data from the cloud.", false); } },
            setupEventListeners() { document.getElementById('customerForm').addEventListener('submit', (e) => this.handleAddCustomer(e)); document.getElementById('dailyUpdateForm').addEventListener('submit', (e) => this.handleAddDailyUpdate(e)); document.getElementById('updateForm').addEventListener('submit', (e) => this.handleUpdateCustomer(e)); document.getElementById('historySearchInput').addEventListener('input', (e) => this.handleHistorySearchInput(e)); document.getElementById('dailyUpdateCustomerSearch').addEventListener('input', (e) => this.handleDailyUpdateSearchInput(e)); this.modal.addEventListener('click', (e) => { if (e.target === this.modal) this.closeModal(); }); },
            async handleAddCustomer(e) { e.preventDefault(); const form = e.target; const button = form.querySelector('button[type="submit"]'); toggleButtonLoading(button, true, button.innerHTML); const newCustomer = { dateAdded: new Date().toISOString(), name: form.elements.customerName.value.trim(), phone: form.elements.phoneNumber.value.trim(), email: form.elements.email.value.trim(), location: form.elements.location.value.trim(), adSource: form.elements.adSource.value, interestedProduct: form.elements.interestedProduct.value.trim(), budget: form.elements.budget.value, leadStatus: form.elements.leadStatus.value, priority: form.elements.priority.value, nextFollowUp: form.elements.nextFollowUp.value, notes: [{ date: new Date().toISOString(), text: form.elements.initialResponse.value.trim() }] }; if (await this.handleApiRequest('add-customer', newCustomer, 'Customer saved!')) { form.reset(); await this.loadAllDataFromServer(); } toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Save Customer'); },
            async handleAddDailyUpdate(e) { e.preventDefault(); const form = e.target; const button = form.querySelector('button[type="submit"]'); toggleButtonLoading(button, true, button.innerHTML); const customerId = document.getElementById('dailyUpdateCustomerId').value; if (!customerId) { showNotification("Please select a valid customer from the list.", false); toggleButtonLoading(button, false, '<i class="fas fa-comment-medical"></i> Add Update'); return; } const newUpdate = { date: new Date().toISOString(), customerId: customerId, supportPerson: form.elements.supportPerson.value.trim(), interactionType: form.elements.callStatus.value, comment: form.elements.dailyComment.value.trim(), }; const customer = this.customers.find(c => c.id === newUpdate.customerId); if (customer) newUpdate.customerName = customer.name; if (await this.handleApiRequest('add-daily-update', newUpdate, 'Update saved!')) { form.reset(); document.getElementById('dailyUpdateCustomerId').value = ''; await this.loadAllDataFromServer(); } toggleButtonLoading(button, false, '<i class="fas fa-comment-medical"></i> Add Update'); },
            async handleUpdateCustomer(e) { e.preventDefault(); const form = e.target; const button = form.querySelector('button[type="submit"]'); toggleButtonLoading(button, true, button.innerHTML); const customerId = document.getElementById('updateCustomerIdModal').value; const updatedData = { name: document.getElementById('updateName').value.trim(), phone: document.getElementById('updatePhone').value.trim(), email: document.getElementById('updateEmail').value.trim(), location: document.getElementById('updateLocation').value.trim(), leadStatus: document.getElementById('updateStatus').value, priority: document.getElementById('updatePriority').value, nextFollowUp: document.getElementById('updateFollowUp').value, }; if (await this.handleApiRequest('update-customer', { id: customerId, data: updatedData }, 'Customer updated!')) { this.closeModal(); await this.loadAllDataFromServer(); } toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Update Customer'); },
            async handleDeleteCustomer(customerId) { if (!confirm('Are you sure you want to delete this customer? This cannot be undone.')) return; if (await this.handleApiRequest('delete-customer', { id: customerId }, 'Customer deleted.')) { await this.loadAllDataFromServer(); } },
            renderAll() { const filtered = this.getFilteredCustomers(); this.displayCustomers(filtered); this.displayDailyUpdates(); this.displayFollowUps(); this.populateDatalists(); this.updateAnalyticsDashboard(filtered); if (document.querySelector('#analytics.tab-content.active')) { this.renderCharts(filtered); } },
            getFilteredCustomers() { const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim(); const statusFilter = document.getElementById('statusFilter').value; const productFilter = document.getElementById('productFilter').value.toLowerCase().trim(); return this.customers.filter(customer => { const matchesSearch = !searchTerm ? true : (customer.name && customer.name.toLowerCase().includes(searchTerm)) || (customer.phone && customer.phone.includes(searchTerm)); const matchesStatus = !statusFilter ? true : customer.leadStatus === statusFilter; const matchesProduct = !productFilter ? true : (customer.interestedProduct && customer.interestedProduct.toLowerCase().includes(productFilter)); return matchesSearch && matchesStatus && matchesProduct; }); },
            displayCustomers(filteredCustomers) { const tableBody = document.getElementById('customerTableBody'); document.getElementById('customerTableHeader').innerHTML = `<tr><th>Customer</th><th>Contact</th><th>Interest</th><th>Status</th><th>Next Follow-up</th><th>Actions</th></tr>`; if (filteredCustomers.length === 0) { tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">No customers match filters.</td></tr>'; return; } tableBody.innerHTML = filteredCustomers.map(cust => `<tr><td data-label="Customer"><strong>${cust.name}</strong><br><small>${cust.location || 'N/A'}</small></td><td data-label="Contact" class="contact-links"><a href="tel:${cust.phone}" class="phone-link"><i class="fas fa-phone"></i> Call</a><a href="https://wa.me/${formatPhoneForWhatsApp(cust.phone)}" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a></td><td data-label="Interest">${cust.interestedProduct || 'N/A'}</td><td data-label="Status">${cust.leadStatus}</td><td data-label="Next Follow-up">${cust.nextFollowUp || 'N/A'}</td><td data-label="Actions"><button class="btn btn-secondary" style="padding: 5px 10px;" onclick="crmApp.openUpdateModal('${cust.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-danger" style="padding: 5px 10px;" onclick="crmApp.handleDeleteCustomer('${cust.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join(''); },
            displayDailyUpdates() { const list = document.getElementById('dailyUpdatesList'); if (this.dailyUpdates.length === 0) { list.innerHTML = '<p style="text-align:center;">No recent updates.</p>'; return; } list.innerHTML = this.dailyUpdates.slice(0, 25).map(update => { const customer = this.customers.find(c => c.id === update.customerId); const customerName = update.customerName || (customer ? customer.name : 'Unknown'); const contactLinksHtml = customer ? `<div class="contact-links" style="justify-content: flex-start; margin-top: 0.5rem;"><a href="tel:${customer.phone}" class="phone-link"><i class="fas fa-phone"></i> Call</a><a href="https://wa.me/${formatPhoneForWhatsApp(customer.phone)}" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a></div>` : ''; return `<div style="border-left: 3px solid var(--gold-primary); padding-left: 1rem; margin-bottom: 1rem;"><div style="display: flex; justify-content: space-between;"><strong>${customerName}</strong><small>${new Date(update.date).toLocaleDateString()}</small></div><p><em>By: ${update.supportPerson} | ${update.interactionType}</em></p><p>${update.comment}</p>${contactLinksHtml}</div>`; }).join(''); },
            displayFollowUps() { const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0); const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999); const activeCustomers = this.customers.filter(c => c.leadStatus !== 'Converted' && c.leadStatus !== 'Not Interested'); const overdue = activeCustomers.filter(c => c.nextFollowUp && new Date(c.nextFollowUp) < todayStart); const today = activeCustomers.filter(c => c.nextFollowUp && new Date(c.nextFollowUp) >= todayStart && new Date(c.nextFollowUp) <= todayEnd); const upcoming = activeCustomers.filter(c => c.nextFollowUp && new Date(c.nextFollowUp) > todayEnd); const renderList = (custs, isOverdue = false) => { if (custs.length === 0) return `<p style="text-align: center;">None</p>`; return custs.map(c => `<div class="note-item"><div style="cursor:pointer;" onclick="crmApp.openUpdateModal('${c.id}')"><strong>${c.name}</strong><br><small>Due: ${new Date(c.nextFollowUp).toLocaleDateString()}</small></div><div class="contact-links" style="justify-content: flex-start; margin-top: 0.5rem;"><a href="tel:${c.phone}" class="phone-link"><i class="fas fa-phone"></i> Call</a><a href="https://wa.me/${formatPhoneForWhatsApp(c.phone)}" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a></div></div>`).join(''); }; document.getElementById('overdueFollowUps').innerHTML = renderList(overdue, true); document.getElementById('todayFollowUps').innerHTML = renderList(today); document.getElementById('upcomingFollowUps').innerHTML = renderList(upcoming); },
            populateDatalists() { const productList = document.getElementById('productList'); const historyCustomerList = document.getElementById('historyCustomerList'); const dailyUpdateCustomerList = document.getElementById('dailyUpdateCustomerList'); if(!this.customers || this.customers.length === 0) return; const uniqueProducts = [...new Set(this.customers.map(c => c.interestedProduct).filter(p => p))]; productList.innerHTML = uniqueProducts.map(p => `<option value="${p}"></option>`).join(''); const customerOptions = this.customers.map(customer => `<option value="${customer.name} - ${customer.phone}" data-id="${customer.id}"></option>`).join(''); historyCustomerList.innerHTML = customerOptions; dailyUpdateCustomerList.innerHTML = customerOptions; },
            handleDailyUpdateSearchInput(event) { const value = event.target.value; const hiddenInput = document.getElementById('dailyUpdateCustomerId'); const options = document.getElementById('dailyUpdateCustomerList').options; hiddenInput.value = ''; for (let i = 0; i < options.length; i++) { if (options[i].value === value) { hiddenInput.value = options[i].getAttribute('data-id'); break; } } },
            handleHistorySearchInput(event) { const value = event.target.value; const options = document.getElementById('historyCustomerList').options; for (let i = 0; i < options.length; i++) { if (options[i].value === value) { this.displayFullCustomerHistory(options[i].getAttribute('data-id')); break; } } },
            searchAndDisplayHistory() { const value = document.getElementById('historySearchInput').value; const options = document.getElementById('historyCustomerList').options; let customerId = null; for (let i = 0; i < options.length; i++) { if (options[i].value === value) { customerId = options[i].getAttribute('data-id'); break; } } if (customerId) { this.displayFullCustomerHistory(customerId); } else { showNotification("Please select a valid customer.", false); } },
            displayFullCustomerHistory(customerId) { const container = document.getElementById('customerHistoryLog'); if (!customerId) { container.style.display = 'none'; return; } container.style.display = 'block'; const customer = this.customers.find(c => c.id === customerId); const customerUpdates = this.dailyUpdates.filter(u => u.customerId === customerId); const customerNotes = customer.notes || []; const history = [...customerUpdates, ...customerNotes].sort((a,b) => new Date(b.date) - new Date(a.date)); if (history.length === 0) { container.innerHTML = '<p>No history recorded.</p>'; return; } container.innerHTML = history.map(item => { const itemDate = new Date(item.date || item.timestamp).toLocaleString('en-IN'); if (item.text) { return `<div style="border-left: 3px solid #5bc0de; padding-left: 1rem; margin-bottom: 1rem;"><strong>Initial Note</strong> <small>(${itemDate})</small><p>${item.text}</p></div>`; } else { return `<div style="border-left: 3px solid var(--gold-primary); padding-left: 1rem; margin-bottom: 1rem;"><strong>Update by ${item.supportPerson}</strong> <small>(${itemDate})</small><p><em>Interaction: ${item.interactionType}</em></p><p>${item.comment}</p></div>`; } }).join(''); },
            updateAnalyticsDashboard(filteredCustomers) { const dataSet = filteredCustomers || this.customers; const total = dataSet.length; const converted = dataSet.filter(c => c.leadStatus === 'Converted').length; const today = new Date().toISOString().split('T')[0]; const todayUpdatesCount = this.dailyUpdates.filter(u => u.date.startsWith(today)).length; const pendingFollowUps = dataSet.filter(c => c.nextFollowUp && new Date(c.nextFollowUp) < new Date()).length; document.getElementById('totalLeads').textContent = total; document.getElementById('conversionRate').textContent = total > 0 ? `${Math.round((converted/total)*100)}%` : '0%'; document.getElementById('todayUpdates').textContent = todayUpdatesCount; document.getElementById('followUpPending').textContent = pendingFollowUps; const sourceCounts = dataSet.reduce((acc, c) => { if (c.adSource) { acc[c.adSource] = (acc[c.adSource] || 0) + 1; } return acc; }, {}); const sourceDashboard = document.getElementById('sourceCountDashboard'); sourceDashboard.innerHTML = Object.keys(sourceCounts).map(source => `<div class="analytics-card"><h4>${sourceCounts[source]}</h4><p>${source}</p></div>`).join(''); },
            renderCharts(filteredCustomers) { const dataSet = filteredCustomers || this.customers; Object.values(this.charts).forEach(chart => { if (chart.destroy) chart.destroy(); }); const chartLabelColor = '#AAAAAA'; const statusCounts = dataSet.reduce((acc, c) => { acc[c.leadStatus] = (acc[c.leadStatus] || 0) + 1; return acc; }, {}); this.charts.status = new Chart(document.getElementById('statusChart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#DCCA87', '#5bc0de', '#5cb85c', '#f0ad4e', '#d9534f', '#8a6de9'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: chartLabelColor } } } } }); const sourceCounts = dataSet.reduce((acc, c) => { acc[c.adSource] = (acc[c.adSource] || 0) + 1; return acc; }, {}); this.charts.source = new Chart(document.getElementById('sourceChart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(sourceCounts), datasets: [{ data: Object.values(sourceCounts), backgroundColor: ['#DCCA87', '#AAAAAA', '#F5EFE1', '#5bc0de', '#5cb85c'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: chartLabelColor } } } } }); },
            showTab(tabName, element) { document.querySelectorAll('#crmPortal .tab-content').forEach(c => c.classList.remove('active')); document.querySelectorAll('#crmPortal .tab-button').forEach(b => b.classList.remove('active')); document.getElementById(tabName).classList.add('active'); element.classList.add('active'); if (tabName !== 'add-customer') { this.renderAll(); } },
            openUpdateModal(customerId) { const customer = this.customers.find(c => c.id === customerId); if (!customer) return; const form = document.getElementById('updateForm'); form.elements.updateCustomerIdModal.value = customer.id; form.elements.updateName.value = customer.name; form.elements.updatePhone.value = customer.phone; form.elements.updateEmail.value = customer.email || ''; form.elements.updateLocation.value = customer.location || ''; form.elements.updateStatus.value = customer.leadStatus; form.elements.updatePriority.value = customer.priority; form.elements.updateFollowUp.value = customer.nextFollowUp || ''; this.displayCustomerHistoryInModal(customerId); this.modal.classList.add('show'); },
            displayCustomerHistoryInModal(customerId) { const container = document.getElementById('customerUpdateHistory'); const customer = this.customers.find(c => c.id === customerId); const customerUpdates = this.dailyUpdates.filter(u => u.customerId === customerId); const customerNotes = customer.notes || []; const history = [...customerUpdates, ...customerNotes].sort((a,b) => new Date(b.date) - new Date(a.date)); if (history.length === 0) { container.innerHTML = '<p>No history for this customer.</p>'; return; } container.innerHTML = history.slice(0, 5).map(item => { const itemDate = new Date(item.date || item.timestamp).toLocaleString('en-IN'); if (item.text) { return `<div style="border-left: 3px solid #5bc0de; padding-left: 1rem; margin-bottom: 1rem;"><strong>Initial Note</strong> <small>(${itemDate})</small><p>${item.text}</p></div>`; } else { return `<div style="border-left: 3px solid var(--gold-primary); padding-left: 1rem; margin-bottom: 1rem;"><strong>Update by ${item.supportPerson}</strong> <small>(${itemDate})</small><p>${item.comment}</p></div>`; } }).join(''); },
            closeModal() { this.modal.classList.remove('show'); }
        };

        // ===================================================================================
        // ======================= ORDER MANAGEMENT & STAFF APP ==============================
        // ===================================================================================
        const orderApp = {
            orders: [], archivedOrders: [], staff: [], charts: {},

            init() {
                this.showTab('new-order', document.querySelector('#orderPortal .tab-button'));
                this.loadAllDataFromServer();
                this.setupEventListeners();
            },

            initStaffPortal() {
                if (this.staff.length === 0 && this.orders.length === 0) { this.loadAllDataFromServer(); } 
                else { this.renderStaffList(); }
                document.getElementById('addStaffForm').addEventListener('submit', (e) => this.handleAddStaff(e));
            },

            async handleApiRequest(endpoint, body, successMessage) { return crmApp.handleApiRequest(endpoint, body, successMessage); },
            
            async loadAllDataFromServer() {
                try {
                    const response = await fetch('/.netlify/functions/get-order-data');
                    if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                    const data = await response.json();
                    
                    let loadedOrders = (data.orders || []).map(o => ({...o, id: o.id }));
                    
                    loadedOrders.forEach(order => {
                        if (!order.items && order.itemName) {
                            order.items = [{
                                name: order.itemName,
                                weight: order.weight || '',
                                workerName: order.workerName || 'Unassigned',
                                status: order.status || 'Pending'
                            }];
                        }
                    });

                    this.orders = loadedOrders;
                    this.archivedOrders = (data.archivedOrders || []).map(o => ({...o, id: o.id }));
                    this.staff = (data.staff || []).map(s => ({...s, id: s.id }));
                    this.orders.sort((a, b) => b.orderNumber - a.orderNumber);
                    
                    this.renderAll(); 
                    this.renderStaffList();

                } catch(error) { showNotification(`Could not load Order data. ${error.message}`, false); console.error(error); }
            },
            
            renderAll() {
                this.renderOrders();
                this.populateDatalistsAndFilters();
                this.updateDashboard();
                if (document.querySelector('#order-dashboard.tab-content.active')) { this.renderCharts(); }
            },
            
            populateDatalistsAndFilters() {
                const allKnownOrders = [...this.orders, ...this.archivedOrders];
                const workerDatalist = document.querySelector('#order-new-order [list="workerDatalist"]');
                const uniqueWorkers = [...new Set(allKnownOrders.flatMap(o => (o.items || []).map(i => i.workerName)).filter(Boolean))];
                if(workerDatalist) {
                    const datalist = document.getElementById('workerDatalist') || document.createElement('datalist');
                    datalist.id = 'workerDatalist';
                    datalist.innerHTML = uniqueWorkers.map(name => `<option value="${name}"></option>`).join('');
                    document.body.appendChild(datalist);
                }

                const staffFilter = document.getElementById('staffFilter');
                const assignedToSelect = document.getElementById('assignedTo');
                const staffOptions = this.staff.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
                
                if(staffFilter) staffFilter.innerHTML = `<option value="all">All Staff</option>${staffOptions}`;
                if(assignedToSelect) assignedToSelect.innerHTML = staffOptions;
            },

            showTab(tabName, element) {
                document.querySelectorAll('#orderPortal .tab-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('#orderPortal .tab-button').forEach(b => b.classList.remove('active'));
                document.getElementById(`order-${tabName}`).classList.add('active');
                element.classList.add('active');
                this.renderAll();
            },

            setupEventListeners() {
                document.getElementById('newOrderForm').addEventListener('submit', (e) => this.handleAddOrder(e));
                document.getElementById('updateOrderForm').addEventListener('submit', (e) => this.handleUpdateOrder(e));
                document.getElementById('addNoteBtn').addEventListener('click', () => this.handleAddCustomerNote());
                document.getElementById('orderUpdateModal').addEventListener('click', (e) => { if (e.target.id === 'orderUpdateModal') this.closeModal('orderUpdateModal'); });
                document.getElementById('imageModal').addEventListener('click', () => this.closeModal('imageModal'));
            },

            addOrderItemRow() {
                const container = document.getElementById('orderItemsList');
                const itemId = `item_${Date.now()}`;
                const itemHtml = `
                    <div class="order-item-row" id="${itemId}">
                        <button type="button" class="remove-item-btn" onclick="orderApp.removeOrderItemRow('${itemId}')">&times;</button>
                        <div class="form-group"><label>Item Name</label><input type="text" class="item-name" required></div>
                        <div class="form-group"><label>Weight (g)</label><input type="text" class="item-weight"></div>
                        <div class="form-group"><label>Worker</label><input type="text" class="item-worker" list="workerDatalist"></div>
                        <div class="form-group">
                            <label>Item Status</label>
                            <select class="item-status">
                                <option value="Pending">Pending</option>
                                <option value="In-Progress">In-Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Delivered">Delivered</option>
                            </select>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', itemHtml);
            },

            removeOrderItemRow(itemId) {
                document.getElementById(itemId)?.remove();
            },

            async handleAddOrder(e) {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');
                toggleButtonLoading(button, true, button.innerHTML);
                
                const items = [];
                document.querySelectorAll('#orderItemsList .order-item-row').forEach(row => {
                    items.push({
                        name: row.querySelector('.item-name').value,
                        weight: row.querySelector('.item-weight').value,
                        workerName: row.querySelector('.item-worker').value,
                        status: row.querySelector('.item-status').value,
                    });
                });

                if (items.length === 0) {
                    showNotification("Please add at least one item to the order.", false);
                    toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Save Order');
                    return;
                }

                const imageFiles = form.elements.itemPictures.files;
                let itemPictureUrls = [];
                if (imageFiles.length > 0) {
                    const base64Promises = Array.from(imageFiles).map(file => this.fileToBase64(file));
                    try {
                        itemPictureUrls = await Promise.all(base64Promises);
                    } catch (error) {
                        showNotification("Could not process one or more images.", false);
                        toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Save Order');
                        return;
                    }
                }

                const newOrder = {
                    orderNumber: parseInt(form.elements.orderNumber.value),
                    customerName: form.elements.orderCustomerName.value.trim(),
                    phoneNumber: form.elements.orderPhoneNumber.value.trim(),
                    city: form.elements.city.value.trim(),
                    orderDate: form.elements.orderDate.value || new Date().toISOString().split('T')[0],
                    deliveryDate: form.elements.deliveryDate.value,
                    assignedTo: form.elements.assignedTo.value,
                    specifications: form.elements.specifications.value.trim(),
                    modifications: form.elements.modifications.value.trim(),
                    itemPictureUrls: itemPictureUrls,
                    status: 'Pending',
                    customerNotes: [],
                    dateAdded: new Date().toISOString(),
                    items: items
                };

                if (await this.handleApiRequest('add-order', newOrder, 'Order saved successfully!')) {
                    form.reset();
                    document.getElementById('orderItemsList').innerHTML = '';
                    await this.loadAllDataFromServer();
                    this.showTab('order-tracking', document.querySelector('#orderPortal button[onclick*="order-tracking"]'));
                }
                toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Save Order');
            },
            
            renderOrders() {
                const tableBody = document.getElementById('orderTableBody');
                document.getElementById('orderTableHeader').innerHTML = `<tr><th>Image</th><th>Order #</th><th>Customer</th><th>Contact</th><th>Delivery Date</th><th>Overseen By</th><th>Items</th><th>Actions</th></tr>`;
                
                const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase();
                const specialFilter = document.getElementById('specialFilter').value;
                const staffFilter = document.getElementById('staffFilter').value;
                const today = new Date(); today.setHours(0, 0, 0, 0);

                let filteredOrders = this.orders.filter(o => {
                    const matchesSearch = !searchTerm || o.orderNumber.toString().includes(searchTerm) || o.customerName.toLowerCase().includes(searchTerm) || o.phoneNumber.includes(searchTerm);
                    const matchesStaff = staffFilter === 'all' || o.assignedTo === staffFilter;
                    
                    let matchesSpecial = false;
                    if (specialFilter === 'all') { matchesSpecial = o.status !== 'Delivered';
                    } else if (specialFilter === 'overdue') { matchesSpecial = o.deliveryDate && new Date(o.deliveryDate) < today && o.status !== 'Delivered';
                    } else if (specialFilter === 'unassigned') { matchesSpecial = (o.items || []).some(item => !item.workerName);
                    } else if (specialFilter === 'completedNotDelivered') {  matchesSpecial = o.status === 'Completed';
                    } else if (specialFilter === 'delivered') { matchesSpecial = o.status === 'Delivered'; }
                    
                    return matchesSearch && matchesStaff && matchesSpecial;
                });

                if (filteredOrders.length === 0) { tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center; padding: 2rem;">No orders match filters.</td></tr>`; return; }

                let tableHtml = '';
                filteredOrders.forEach(order => {
                    const items = order.items || [];
                    const isOverdue = order.deliveryDate && new Date(order.deliveryDate) < today && order.status !== 'Delivered';
                    const dateHtml = order.deliveryDate ? `${new Date(order.deliveryDate).toLocaleDateString('en-IN')} ${isOverdue ? '<i class="fas fa-exclamation-triangle" style="color: var(--danger-red);"></i>' : ''}` : 'N/A';
                    const imageHtml = order.itemPictureUrls && order.itemPictureUrls.length > 0
                        ? `<img src="${order.itemPictureUrls[0]}" class="order-image-thumbnail" onclick="orderApp.openImageModal('${order.id}')">`
                        : `<span>No Image</span>`;
                    const staffOptions = this.staff.map(s => `<option value="${s.name}" ${order.assignedTo === s.name ? 'selected' : ''}>${s.name}</option>`).join('');

                    tableHtml += `
                    <tr id="order-row-${order.id}">
                        <td data-label="Image">${imageHtml}</td>
                        <td data-label="Order #">${order.orderNumber}</td>
                        <td data-label="Customer"><strong>${order.customerName}</strong><br><small>${order.city || 'N/A'}</small></td>
                        <td data-label="Contact" class="contact-links"><a href="tel:${order.phoneNumber}" class="phone-link"><i class="fas fa-phone"></i></a><a href="https://wa.me/${formatPhoneForWhatsApp(order.phoneNumber)}" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i></a></td>
                        <td data-label="Delivery Date">${dateHtml}</td>
                        <td data-label="Overseen By">${order.assignedTo || 'N/A'}</td>
                        <td data-label="Items"><button class="btn btn-secondary" style="padding: 5px 10px;" onclick="orderApp.toggleItemDetails('${order.id}')">${items.length} Items</button></td>
                        <td data-label="Actions"><button class="btn btn-primary" style="padding: 5px 10px;" onclick="orderApp.openUpdateModal('${order.id}')"><i class="fas fa-edit"></i></button></td>
                    </tr>
                    <tr class="details-row" id="details-row-${order.id}"><td colspan="8">
                        <div class="details-content">
                            <div class="form-group" style="max-width: 300px; margin-bottom: 1.5rem;">
                                <label>Change "Overseen By"</label>
                                <select class="assigned-staff-select">${staffOptions}</select>
                            </div>
                            <h4>Item Details</h4>
                            ${items.length > 0 ? items.map((item, index) => `
                                <div class="inline-item-update">
                                    <strong>${item.name} (${item.weight}g)</strong>
                                    <input type="text" class="inline-item-worker" value="${item.workerName || ''}" placeholder="Assign Worker..." list="workerDatalist">
                                    <select class="inline-item-status">
                                        <option value="Pending" ${item.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                        <option value="In-Progress" ${item.status === 'In-Progress' ? 'selected' : ''}>In-Progress</option>
                                        <option value="Completed" ${item.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                        <option value="Delivered" ${item.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                    </select>
                                </div>
                            `).join('') : '<p>No items found for this order.</p>'}
                            <div style="text-align: right; margin-top: 1rem;">
                                <button class="btn btn-primary" data-order-id="${order.id}" onclick="orderApp.handleInlineUpdate(this)">Save Changes</button>
                            </div>
                            ${order.specifications ? `<h4>Specifications</h4><p>${order.specifications.replace(/\n/g, '<br>')}</p>` : ''}
                            ${order.modifications ? `<h4>Modifications</h4><p>${order.modifications.replace(/\n/g, '<br>')}</p>` : ''}
                        </div>
                    </td></tr>`;
                });
                tableBody.innerHTML = tableHtml;
            },
            
            toggleItemDetails(orderId) {
                document.getElementById(`details-row-${orderId}`).classList.toggle('show');
            },

            async handleInlineUpdate(button) {
                const orderId = button.dataset.orderId;
                const order = this.orders.find(o => o.id === orderId);
                if (!order) return showNotification("Order not found.", false);

                toggleButtonLoading(button, true, button.innerHTML);

                const detailsRow = document.getElementById(`details-row-${orderId}`);
                const newAssignedTo = detailsRow.querySelector('.assigned-staff-select').value;
                
                const updatedItems = [];
                detailsRow.querySelectorAll('.inline-item-update').forEach((itemRow, index) => {
                    const originalItem = order.items[index];
                    updatedItems.push({
                        ...originalItem,
                        workerName: itemRow.querySelector('.inline-item-worker').value.trim(),
                        status: itemRow.querySelector('.inline-item-status').value
                    });
                });
                
                const allItemsDelivered = updatedItems.length > 0 && updatedItems.every(item => item.status === 'Delivered');
                const allItemsCompleted = updatedItems.every(item => item.status === 'Completed' || item.status === 'Delivered');

                let mainStatus = 'Pending';
                if(allItemsDelivered) mainStatus = 'Delivered';
                else if (allItemsCompleted) mainStatus = 'Completed';
                else if (updatedItems.some(i => i.status !== 'Pending')) mainStatus = 'In-Progress';

                const updates = { assignedTo: newAssignedTo, items: updatedItems, status: mainStatus };
                
                if (await this.handleApiRequest('update-order', { id: orderId, updates }, 'Order updated!')) {
                    order.assignedTo = newAssignedTo;
                    order.items = updatedItems;
                    order.status = mainStatus;
                    this.renderOrders(); 
                } else {
                    toggleButtonLoading(button, false, 'Save Changes');
                }
            },

            async handleUpdateOrder(e) {
                e.preventDefault();
                const button = e.target.querySelector('button[type="submit"]');
                toggleButtonLoading(button, true, button.innerHTML);
                const orderId = document.getElementById('updateOrderId').value;
                
                const updatedItems = [];
                document.querySelectorAll('#updateOrderItemsList .order-item-row').forEach(row => {
                    updatedItems.push({
                        name: row.dataset.name, weight: row.dataset.weight,
                        workerName: row.querySelector('.update-item-worker').value, status: row.querySelector('.update-item-status').value
                    });
                });
                
                const allItemsDelivered = updatedItems.length > 0 && updatedItems.every(item => item.status === 'Delivered');
                const allItemsCompleted = updatedItems.every(item => item.status === 'Completed' || item.status === 'Delivered');

                let mainStatus = 'Pending';
                if(allItemsDelivered) mainStatus = 'Delivered';
                else if (allItemsCompleted) mainStatus = 'Completed';
                else if (updatedItems.some(i => i.status !== 'Pending')) mainStatus = 'In-Progress';

                const updates = {
                    items: updatedItems,
                    specifications: document.getElementById('updateSpecifications').value.trim(),
                    modifications: document.getElementById('updateModifications').value.trim(),
                    status: mainStatus,
                };

                if (await this.handleApiRequest('update-order', { id: orderId, updates }, 'Order updated!')) {
                    this.closeModal('orderUpdateModal');
                    await this.loadAllDataFromServer();
                }
                toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Save Changes');
            },

            openUpdateModal(orderId) {
                const order = this.orders.find(o => o.id === orderId);
                if (!order) return;
                document.getElementById('updateOrderId').value = order.id;
                document.getElementById('updateSpecifications').value = order.specifications || '';
                document.getElementById('updateModifications').value = order.modifications || '';

                const itemsContainer = document.getElementById('updateOrderItemsList');
                const items = order.items || [];
                itemsContainer.innerHTML = items.map(item => `
                    <div class="order-item-row" data-name="${item.name}" data-weight="${item.weight}">
                        <div class="form-group">
                            <label>${item.name} (${item.weight}g)</label>
                            <input type="text" class="update-item-worker" value="${item.workerName || ''}" placeholder="Assign Worker..." list="workerDatalist">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="update-item-status">
                                <option value="Pending" ${item.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="In-Progress" ${item.status === 'In-Progress' ? 'selected' : ''}>In-Progress</option>
                                <option value="Completed" ${item.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                <option value="Delivered" ${item.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </div>
                    </div>
                `).join('');

                document.getElementById('newCustomerNote').value = '';
                this.renderNotesHistory(order.customerNotes || []);
                document.getElementById('orderUpdateModal').classList.add('show');
            },

            renderCharts() { 
                if (this.charts.worker) this.charts.worker.destroy(); 
                const allKnownOrders = [...this.orders, ...this.archivedOrders]; 
                const workerCounts = allKnownOrders.reduce((acc, order) => { 
                    (order.items || []).forEach(item => {
                        const worker = item.workerName || 'Unassigned'; 
                        acc[worker] = (acc[worker] || 0) + 1; 
                    }); return acc; 
                }, {}); 
                if(document.getElementById('workerChart')) {
                    this.charts.worker = new Chart(document.getElementById('workerChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(workerCounts), datasets: [{ label: 'Number of Items Assigned', data: Object.values(workerCounts), backgroundColor: '#DCCA87' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#AAAAAA', stepSize: 1 } }, x: { ticks: { color: '#AAAAAA' } } }, plugins: { legend: { display: false } } } }); 
                }
            },

            renderStaffList() {
                const container = document.getElementById('staffListContainer');
                if(!container) return;
                if (this.staff.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">No staff members added yet.</p>';
                    return;
                }
                container.innerHTML = this.staff.map(s => `
                    <div class="staff-list-item">
                        <span>${s.name}</span>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="orderApp.handleDeleteStaff('${s.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            },

            async handleAddStaff(e) {
                e.preventDefault();
                const input = document.getElementById('newStaffName');
                const name = input.value.trim();
                if (!name) return showNotification("Staff name cannot be empty.", false);
                
                if (await this.handleApiRequest('add-staff', { name }, 'Staff member added!')) {
                    input.value = '';
                    await this.loadAllDataFromServer();
                }
            },

            async handleDeleteStaff(staffId) {
                if (!confirm('Are you sure you want to delete this staff member?')) return;
                if (await this.handleApiRequest('delete-staff', { id: staffId }, 'Staff member deleted.')) {
                    await this.loadAllDataFromServer();
                }
            },

            fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); },
            
            async handleAddCustomerNote() { const orderId = document.getElementById('updateOrderId').value; const noteText = document.getElementById('newCustomerNote').value.trim(); if (!noteText) { showNotification("Note cannot be empty.", false); return; } const newNote = { text: noteText, timestamp: new Date().toISOString() }; if (await this.handleApiRequest('add-order-note', { id: orderId, note: newNote }, 'Note added!')) { document.getElementById('newCustomerNote').value = ''; await this.loadAllDataFromServer(); const order = this.orders.find(o => o.id === orderId); this.renderNotesHistory(order ? order.customerNotes : []); } },
            
            updateDashboard() { const totalActiveOrders = this.orders.length; const pending = this.orders.filter(o => o.status === 'Pending').length; const inProgress = this.orders.filter(o => o.status === 'In-Progress').length; const overdue = this.orders.filter(o => o.deliveryDate && new Date(o.deliveryDate) < new Date() && o.status !== 'Delivered').length; const dashboard = document.getElementById('orderAnalyticsDashboard'); if(!dashboard) return; dashboard.querySelector('#totalOrders').textContent = totalActiveOrders + this.archivedOrders.length; dashboard.querySelector('#pendingOrders').textContent = pending; dashboard.querySelector('#inProgressOrders').textContent = inProgress; dashboard.querySelector('#overdueCount').textContent = overdue; dashboard.querySelector('#deliveredCount').textContent = this.archivedOrders.length; },
            
            renderNotesHistory(notes) { const historyContainer = document.getElementById('orderUpdateModal').querySelector('#customerNotesHistory'); if (!notes || notes.length === 0) { historyContainer.innerHTML = '<p style="text-align: center;">No notes yet.</p>'; return; } historyContainer.innerHTML = [...notes].reverse().map(note => { const formattedDate = new Date(note.timestamp).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'short' }); return `<div class="note-item"><p>${note.text}</p><small>${formattedDate}</small></div>`; }).join(''); },
            
            openImageModal(orderId) { 
                const order = this.orders.find(o => o.id === orderId); 
                const imageUrls = (order.itemPictureUrls && order.itemPictureUrls.length > 0) ? order.itemPictureUrls : (order.itemPictureUrl ? [order.itemPictureUrl] : []);
                if (imageUrls.length > 0) {
                    const container = document.getElementById('fullSizeImageContainer');
                    container.innerHTML = imageUrls.map(url => `<img src="${url}" alt="Full Size Order Image">`).join('');
                    document.getElementById('imageModal').classList.add('show');
                }
            },
            
            closeModal(modalId) { const modal = document.getElementById(modalId); if (modal) modal.classList.remove('show'); }
        };
    </script>
</body>
</html>
 -->
 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Srikar Jewellers - Business Suite</title>
    <link rel="icon" type="image/jpeg" href="logo.jpeg">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {--gold-primary: #DCCA87;--gold-secondary: #F5EFE1;--dark-bg: #0C0C0C;--dark-secondary: #181818;--text-primary: #FFFFFF;--text-secondary: #AAAAAA;--danger-red: #d9534f; --transition-fast: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); --status-pending: #f0ad4e; --status-progress: #5bc0de; --status-completed: #5cb85c; --status-delivered: #8a6de9;}
        * {margin: 0;padding: 0;box-sizing: border-box;}
        body {font-family: 'Poppins', sans-serif;background-color: var(--dark-bg);color: var(--text-secondary);min-height: 100vh; line-height: 1.6;}
        
        #portalSelectionScreen { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; text-align: center; padding: 2rem; background-color: var(--dark-bg); animation: fadeIn 0.8s ease-out; position: relative; z-index: 1; }
        #portalSelectionScreen::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('logo.jpeg'); background-position: center; background-repeat: no-repeat; background-size: 450px; opacity: 0.2; z-index: -1; }
        .container { position: relative; z-index: 1; overflow: hidden; }
        .container::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 95%; height: 95%; background-image: url('logo.jpeg'); background-position: center; background-repeat: no-repeat; background-size: contain; opacity: 0.07; z-index: -1; pointer-events: none; }

        .portal-header { margin-bottom: 3rem; }
        .portal-header h1 { font-family: 'Cormorant Garamond', serif; font-size: 4rem; color: var(--gold-primary); }
        .portal-header p { font-size: 1.2rem; color: var(--text-secondary); }
        .portal-choices { display: flex; flex-wrap: wrap; justify-content: center; gap: 2rem; }
        .portal-card { background: var(--dark-secondary); border: 1px solid rgba(220, 202, 135, 0.15); border-radius: 20px; padding: 3rem 2rem; width: 300px; cursor: pointer; transition: all 0.3s ease; background-color: rgba(24, 24, 24, 0.8); backdrop-filter: blur(5px); }
        .portal-card:hover { transform: translateY(-10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-color: var(--gold-primary); }
        .portal-card i { font-size: 3.5rem; color: var(--gold-primary); margin-bottom: 1.5rem; }
        .portal-card h2 { font-family: 'Cormorant Garamond', serif; font-size: 2rem; color: var(--gold-secondary); margin-bottom: 0.5rem; }
        .portal-card p { color: var(--text-secondary); }

        .app-portal { display: none; }
        .container {max-width: 1800px;margin: 1rem;background: var(--dark-secondary);border: 1px solid rgba(220, 202, 135, 0.15);border-radius: 20px;}
        .header {padding: 2rem 1.5rem;background: #111111;border-bottom: 1px solid rgba(220, 202, 135, 0.15);display: flex;align-items: center;justify-content: space-between;flex-wrap: wrap; gap: 1rem;}
        .header-text h1 {font-family: 'Cormorant Garamond', serif;font-size: 2.5rem;color: var(--gold-primary);}
        
        .logo-container .logo { width: 80px; height: 80px; border-radius: 50%; border: 4px solid var(--gold-primary); box-shadow: 0 0 30px rgba(220, 202, 135, 0.6); }
        
        .nav-tabs {background: var(--dark-secondary);padding: 0 1rem;display: flex;border-bottom: 1px solid rgba(220, 202, 135, 0.1);overflow-x: auto;}
        .nav-tabs button {background: transparent;border: none;padding: 1.2rem 1rem;font-size: 1rem;cursor: pointer;color: var(--text-secondary);border-bottom: 3px solid transparent;transition: var(--transition-fast);white-space: nowrap;}
        .nav-tabs button:hover, .nav-tabs button.active {color: var(--gold-primary);}
        .nav-tabs button.active {border-bottom-color: var(--gold-primary);}
        .nav-tabs button i {margin-right: 0.75rem;}
        .tab-content {padding: 1.5rem; display: none;}
        .tab-content.active {display: block; animation: fadeIn 0.6s ease-out;}
        @keyframes fadeIn {from {opacity: 0;transform: translateY(15px);} to {opacity: 1;transform: translateY(0);}}
        .section-title {font-family: 'Cormorant Garamond', serif;font-size: 2.2rem;color: var(--gold-primary);margin-bottom: 2rem;text-align: center;}
        .premium-card {background: #111111;border: 1px solid rgba(220, 202, 135, 0.1);border-radius: 15px;padding: 1.5rem;margin-bottom: 2rem;}
        .form-grid {display: grid;grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));gap: 1.5rem;}
        .form-group {display: flex;flex-direction: column;}
        .form-group label {margin-bottom: 0.75rem;font-weight: 500;color: var(--gold-secondary);font-size: 0.9rem;text-transform: uppercase;}
        .form-group input, .form-group select, .form-group textarea {width: 100%;padding: 0.8rem 1rem;border: 1px solid rgba(220, 202, 135, 0.2);border-radius: 8px;font-size: 1rem;background: var(--dark-secondary);color: var(--text-primary);transition: var(--transition-fast);}
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {outline: none;border-color: var(--gold-primary);}
        .btn {padding: 0.8rem 1.8rem;border: 1px solid var(--gold-primary);border-radius: 8px;cursor: pointer;font-size: 1rem;font-weight: 600;text-transform: uppercase;transition: var(--transition-fast); display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;}
        .btn-secondary {background: transparent;color: var(--gold-primary);}
        .btn-secondary:hover {background: rgba(220, 202, 135, 0.1);}
        .btn-primary {background: var(--gold-primary);color: var(--dark-bg);}
        .btn-primary:hover {background: #EADCA6;}
        .btn-danger {background: var(--danger-red);color: white;border-color: var(--danger-red);}
        .btn-danger:hover {background: #c9302c;}
        .btn:disabled {background: #555;border-color: #555;color: #888;cursor: not-allowed;}
        .premium-table {width: 100%;border-collapse: collapse;background: #111111;border-radius: 15px;overflow: hidden;}
        .premium-table th, .premium-table td {padding: 1.2rem 1rem;text-align: left;vertical-align: middle; border-bottom: 1px solid rgba(220, 202, 135, 0.1);}
        .premium-table th {background: var(--dark-secondary);color: var(--gold-primary);text-transform: uppercase;}
        .premium-table tbody tr:hover {background: var(--dark-secondary);}
        .order-image-thumbnail {width: 50px; height: 50px; border-radius: 5px; object-fit: cover; cursor: pointer; transition: transform 0.2s ease;}
        .order-image-thumbnail:hover {transform: scale(1.1);}
        .contact-links {display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;}
        .contact-links a {padding: 0.3rem 0.6rem; border-radius: 5px; text-decoration: none; font-size: 0.8rem; display: inline-flex; align-items: center; gap: 0.3rem; transition: var(--transition-fast);}
        .phone-link { background: rgba(92, 184, 230, 0.1); color: #5cb8e6; border: 1px solid rgba(92, 184, 230, 0.3); }
        .phone-link:hover { background: rgba(92, 184, 230, 0.2); }
        .whatsapp-link { background: rgba(37, 211, 102, 0.1); color: #25D366; border: 1px solid rgba(37, 211, 102, 0.3); }
        .whatsapp-link:hover { background: rgba(37, 211, 102, 0.2); }
        .status-badge { padding: 0.3rem 0.7rem; border-radius: 20px; color: white; font-size: 0.8rem; font-weight: 500; text-transform: uppercase; }
        .status-Pending { background-color: var(--status-pending); }
        .status-In-Progress { background-color: var(--status-progress); }
        .status-Completed { background-color: var(--status-completed); }
        .status-Delivered { background-color: var(--status-delivered); }
        .analytics-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .analytics-card { background: #1C1C1C; padding: 1.5rem; border-radius: 10px; text-align: center; border-left: 5px solid var(--gold-primary); }
        .analytics-card h3 { font-size: 2.5rem; color: var(--gold-primary); }
        .analytics-card p { font-size: 1rem; color: var(--text-secondary); margin-top: 0.5rem; }
        .chart-container {height: 350px;padding: 1rem;background: #1C1C1C;border-radius: 10px;}
        .premium-notification {position: fixed;bottom: 20px;left: 50%;transform: translateX(-50%);padding: 1rem 2rem;background: linear-gradient(145deg, #EADCA6 0%, #DCCA87 100%);color: var(--dark-bg);border-radius: 10px;z-index: 9999;font-weight: 600;animation: slideUp 0.5s ease forwards, slideDown 0.5s ease 4.5s forwards;}
        @keyframes slideUp {from {transform: translate(-50%, 150%);} to {transform: translate(-50%, 0);}}
        @keyframes slideDown {from {transform: translate(-50%, 0); opacity: 1;} to {transform: translate(-50%, 150%); opacity: 0;}}
        .modal-premium {position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, 0.7);backdrop-filter: blur(10px);z-index: 1000;display: none;align-items: center;justify-content: center;opacity: 0;transition: opacity 0.4s ease;}
        .modal-premium.show {display: flex;opacity: 1;}
        .modal-content {background: var(--dark-secondary);border: 1px solid rgba(220, 202, 135, 0.2);border-radius: 20px;padding: 2rem;width: 95%;max-width: 800px;max-height: 90vh;overflow-y: auto;}
        
        #imageModal .modal-content { max-width: 90vw; max-height: 90vh; padding: 0.5rem; }
        #fullSizeImageContainer { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; align-items: center; height: 100%; }
        #fullSizeImageContainer img { max-width: 100%; max-height: calc(85vh); object-fit: contain; }

        .filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; align-items: flex-end; }
        .notes-section { margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid rgba(220, 202, 135, 0.15); }
        .note-item { background: #111; padding: 0.8rem; border-radius: 8px; margin-bottom: 0.8rem; border-left: 3px solid var(--gold-primary); }
        .note-item p { margin: 0; color: var(--text-primary); }
        .note-item small { color: var(--text-secondary); font-size: 0.8rem; }
        
        .order-items-container { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(220, 202, 135, 0.1); }
        .order-item-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; align-items: flex-end; padding: 1rem; background: #1C1C1C; border-radius: 10px; margin-bottom: 1rem; position: relative; }
        .order-item-row .remove-item-btn { position: absolute; top: 5px; right: 5px; background: transparent; border: none; color: var(--danger-red); cursor: pointer; font-size: 1.2rem; }
        .details-row { display: none; }
        .details-row.show { display: table-row; background: #0A0A0A; }
        .details-row > td { padding: 0 !important; border: 0 !important; }
        .details-content { padding: 1.5rem; }
        .details-content h4 { color: var(--gold-primary); margin-bottom: 1rem; }
        .staff-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; background: #1C1C1C; border-radius: 8px; margin-bottom: 0.5rem; }
        .inline-item-update { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem; align-items: center; padding: 0.8rem; background: #1C1C1C; border-radius: 8px; margin-bottom: 0.8rem;}
        .details-buttons {display: flex; justify-content: flex-end; gap: 1rem; margin-top: 1rem;}

        @media (max-width: 768px) {
            .portal-header h1 { font-size: 2.5rem; }
            .container { margin: 0; border-radius: 0; }
            .premium-table thead { display: none; }
            .premium-table, .premium-table tbody, .premium-table tr, .premium-table td { display: block; width: 100%; }
            .premium-table tr { margin-bottom: 1rem; border: 1px solid rgba(220, 202, 135, 0.15); border-radius: 10px; padding: 1rem; }
            .premium-table td { padding: 0.75rem 0.5rem; padding-left: 50%; text-align: right; position: relative; border-bottom: 1px solid #222; display: flex; align-items: center; justify-content: flex-end; }
            .premium-table td:last-child { border-bottom: none; }
            .premium-table td::before { content: attr(data-label); position: absolute; left: 0.5rem; width: 45%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: var(--gold-secondary); }
            .inline-item-update { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="portalSelectionScreen">
        <div class="portal-header">
            <h1>Srikar Jewellers</h1>
            <p>Business Suite</p>
        </div>
        <div class="portal-choices">
            <div class="portal-card" onclick="showPortal('crm')">
                <i class="fas fa-users"></i>
                <h2>Insta CRM</h2>
                <p>Manage Customer Leads & Follow-ups</p>
            </div>
            <div class="portal-card" onclick="showPortal('order')">
                <i class="fas fa-gem"></i>
                <h2>Order Management</h2>
                <p>Track Custom Orders & Production</p>
            </div>
             <div class="portal-card" onclick="showPortal('staff')">
                <i class="fas fa-id-card"></i>
                <h2>Staff Management</h2>
                <p>Add or Remove Staff Members</p>
            </div>
        </div>
    </div>

    <div id="crmPortal" class="app-portal">
        <div class="container">
            <header class="header">
                <div class="header-text"><h1>Insta CRM</h1><p>Professional CRM | Bhimavaram</p></div>
                <div class="logo-container"><img src="logo.jpeg" alt="Logo" class="logo"></div>
                <button class="btn btn-secondary" onclick="showPortalSelection()"><i class="fas fa-home"></i> Main Menu</button>
            </header>
            <div class="nav-tabs">
                <button class="tab-button active" onclick="crmApp.showTab('add-customer', this)"><i class="fas fa-plus-circle"></i> Add Customer</button>
                <button class="tab-button" onclick="crmApp.showTab('daily-updates', this)"><i class="fas fa-comments"></i> Daily Updates</button>
                <button class="tab-button" onclick="crmApp.showTab('follow-ups', this)"><i class="fas fa-calendar-check"></i> Follow-ups</button>
                <button class="tab-button" onclick="crmApp.showTab('customer-list', this)"><i class="fas fa-users"></i> Database</button>
                <button class="tab-button" onclick="crmApp.showTab('history', this)"><i class="fas fa-history"></i> Customer History</button>
                <button class="tab-button" onclick="crmApp.showTab('analytics', this)"><i class="fas fa-chart-pie"></i> Analytics</button>
            </div>
            <div id="add-customer" class="tab-content active"><h2 class="section-title">Record New Lead</h2><div class="premium-card"><form id="customerForm"><div class="form-grid"><div class="form-group"><label for="customerName">Customer Name</label><input type="text" id="customerName"></div><div class="form-group"><label for="phoneNumber">Phone Number *</label><input type="tel" id="phoneNumber" required></div><div class="form-group"><label for="email">Email Address</label><input type="email" id="email"></div><div class="form-group"><label for="location">Location</label><input type="text" id="location"></div><div class="form-group"><label for="adSource">Lead Source</label><select id="adSource"><option value="">Select Source</option><option value="Instagram">Instagram</option><option value="Facebook">Facebook</option><option value="Referral">Referral</option><option value="Walk-in">Walk-in</option><option value="Other">Other</option></select></div><div class="form-group"><label for="interestedProduct">Product of Interest</label><input type="text" id="interestedProduct" list="productList"><datalist id="productList"></datalist></div><div class="form-group"><label for="budget">Estimated Budget</label><select id="budget"><option value="">Select Budget</option><option value="<50k">Under ₹50,000</option><option value="50k-1L">₹50k - ₹1 Lakh</option><option value="1L-3L">₹1 Lakh - ₹3 Lakh</option><option value=">5L">Above ₹5 Lakh</option></select></div><div class="form-group"><label for="leadStatus">Initial Status</label><select id="leadStatus"><option value="New">New</option><option value="Contacted">Contacted</option><option value="Interested">Interested</option><option value="Follow-up">Follow-up</option><option value="Not Interested">Not Interested</option></select></div><div class="form-group"><label for="priority">Priority</label><select id="priority"><option value="Medium">Medium</option><option value="High">High</option><option value="Low">Low</option></select></div><div class="form-group"><label for="nextFollowUp">Next Follow-up</label><input type="date" id="nextFollowUp"></div></div><div class="form-group" style="margin-top:1.5rem;"><label for="initialResponse">Notes</label><textarea id="initialResponse" rows="3"></textarea></div><div style="text-align: center; margin-top: 2rem;"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Customer</button></div></form></div></div>
            <div id="daily-updates" class="tab-content"><h2 class="section-title">Daily Customer Updates</h2><div class="premium-card"><h3 style="color: var(--gold-primary); margin-bottom: 1.5rem;"><i class="fas fa-plus-circle"></i> Add Daily Update</h3><form id="dailyUpdateForm"><div class="form-grid"><div class="form-group"><label>Search/Select Customer</label><input type="text" id="dailyUpdateCustomerSearch" list="dailyUpdateCustomerList" placeholder="Start typing name or phone..." required><datalist id="dailyUpdateCustomerList"></datalist><input type="hidden" id="dailyUpdateCustomerId"></div><div class="form-group"><label>Support Person</label><input type="text" id="supportPerson" required></div><div class="form-group"><label>Interaction Type</label><select id="callStatus"><option value="Phone Call">Phone Call</option><option value="WhatsApp">WhatsApp</option><option value="Store Visit">Store Visit</option><option value="Email">Email</option></select></div></div><div class="form-group" style="margin-top: 1rem;"><label>Daily Comment/Update *</label><textarea id="dailyComment" rows="4" required></textarea></div><div style="text-align: center; margin-top: 1.5rem;"><button type="submit" class="btn btn-primary"><i class="fas fa-comment-medical"></i> Add Update</button></div></form></div><div class="premium-card"><h3 style="color: var(--gold-primary); margin-bottom: 1.5rem;"><i class="fas fa-history"></i> Recent Updates</h3><div id="dailyUpdatesList"></div></div></div>
            <div id="follow-ups" class="tab-content"><h2 class="section-title">Follow-up Schedule</h2><div class="form-grid"><div class="premium-card"><h3><i class="fas fa-fire" style="color:#d9534f;"></i> Overdue</h3><div id="overdueFollowUps"></div></div><div class="premium-card"><h3><i class="fas fa-star" style="color:#f0ad4e;"></i> Today</h3><div id="todayFollowUps"></div></div><div class="premium-card"><h3><i class="fas fa-calendar-day" style="color:#5bc0de;"></i> Upcoming</h3><div id="upcomingFollowUps"></div></div></div></div>
            <div id="customer-list" class="tab-content"><h2 class="section-title">Customer Database</h2><div class="premium-card"><div class="form-grid"><div class="form-group"><label>Search by Name/Phone</label><input type="text" id="searchInput" oninput="crmApp.renderAll()"></div><div class="form-group"><label>Filter by Status</label><select id="statusFilter" onchange="crmApp.renderAll()"><option value="">All Statuses</option><option value="New">New</option><option value="Contacted">Contacted</option><option value="Interested">Interested</option><option value="Follow-up">Follow-up</option><option value="Converted">Converted</option><option value="Not Interested">Not Interested</option></select></div><div class="form-group"><label>Filter by Product</label><input type="text" id="productFilter" list="productList" oninput="crmApp.renderAll()" placeholder="Type or select product..."></div></div></div><div class="table-container"><table class="premium-table"><thead id="customerTableHeader"></thead><tbody id="customerTableBody"></tbody></table></div></div>
            <div id="history" class="tab-content"><h2 class="section-title">Full Customer History</h2><div class="premium-card"><div class="form-group"><label>Search Customer by Name or Phone</label><input type="text" id="historySearchInput" list="historyCustomerList" placeholder="Start typing..."><datalist id="historyCustomerList"></datalist></div><div style="text-align:center; margin-top:1rem;"><button class="btn btn-secondary" onclick="crmApp.searchAndDisplayHistory()">Search</button></div></div><div id="customerHistoryLog" class="premium-card" style="display:none;"></div></div>
            <div id="analytics" class="tab-content"><h2 class="section-title">Business Analytics</h2><div class="analytics-dashboard" id="crmAnalyticsDashboard"><div class="analytics-card"><h3 id="totalLeads">0</h3><p>Total Leads</p></div><div class="analytics-card"><h3 id="conversionRate">0%</h3><p>Conversion Rate</p></div><div class="analytics-card"><h3 id="todayUpdates">0</h3><p>Today's Updates</p></div><div class="analytics-card"><h3 id="followUpPending">0</h3><p>Pending Follow-ups</p></div></div><div class="premium-card"><h3 class="section-title" style="font-size: 1.8rem; margin-bottom: 1.5rem;">Customer Count by Lead Source</h3><div id="sourceCountDashboard" class="form-grid"></div></div><div class="form-grid"><div class="premium-card"><h3 class="section-title" style="font-size: 1.5rem;">Lead Sources</h3><div class="chart-container"><canvas id="sourceChart"></canvas></div></div><div class="premium-card"><h3 class="section-title" style="font-size: 1.5rem;">Lead Status</h3><div class="chart-container"><canvas id="statusChart"></canvas></div></div></div></div>
        </div>
        <div id="crmUpdateModal" class="modal-premium"><div class="modal-content"><h2 class="section-title" style="margin-bottom: 1.5rem;">Update Customer & View History</h2><form id="updateForm"><input type="hidden" id="updateCustomerIdModal"><div class="form-grid"><div class="form-group"><label>Customer Name</label><input type="text" id="updateName" required></div><div class="form-group"><label>Phone Number</label><input type="tel" id="updatePhone" required></div><div class="form-group"><label>Email</label><input type="email" id="updateEmail"></div><div class="form-group"><label>Location</label><input type="text" id="updateLocation"></div><div class="form-group"><label>Status</label><select id="updateStatus"><option value="New">New</option><option value="Contacted">Contacted</option><option value="Interested">Interested</option><option value="Follow-up">Follow-up</option><option value="Converted">Converted</option><option value="Not Interested">Not Interested</option></select></div><div class="form-group"><label>Priority</label><select id="updatePriority"><option value="Low">Low</option><option value="Medium">Medium</option><option value="High">High</option></select></div><div class="form-group"><label>Next Follow-up Date</label><input type="date" id="updateFollowUp"></div></div><div style="margin-top: 2rem;"><h3 style="color: var(--gold-primary); margin-bottom: 1rem;"><i class="fas fa-history"></i> Recent History</h3><div id="customerUpdateHistory" style="max-height: 300px; overflow-y: auto;"></div></div><div style="text-align: center; margin-top: 2rem; display:flex; gap: 1rem; justify-content:center;"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Update Customer</button><button type="button" class="btn btn-secondary" onclick="crmApp.closeModal()">Cancel</button></div></form></div></div>
    </div>

    <div id="orderPortal" class="app-portal">
        <div class="container">
            <header class="header">
                <div class="header-text"><h1>Order Management</h1><p>Track Custom Orders & Production</p></div>
                <div class="logo-container"><img src="logo.jpeg" alt="Logo" class="logo"></div>
                <button class="btn btn-secondary" onclick="showPortalSelection()"><i class="fas fa-home"></i> Main Menu</button>
            </header>
            <div class="nav-tabs">
                <button class="tab-button active" onclick="orderApp.showTab('new-order', this)"><i class="fas fa-plus-circle"></i> New Order</button>
                <button class="tab-button" onclick="orderApp.showTab('order-tracking', this)"><i class="fas fa-tasks"></i> Order Tracking</button>
                <button class="tab-button" onclick="orderApp.showTab('dashboard', this)"><i class="fas fa-chart-pie"></i> Dashboard</button>
            </div>
            
            <div id="order-new-order" class="tab-content active">
                <h2 class="section-title">Enter New Order Details</h2>
                <div class="premium-card">
                    <form id="newOrderForm">
                        <h3 style="color: var(--gold-secondary); margin-bottom: 1rem; border-bottom: 1px solid var(--gold-primary); padding-bottom: 0.5rem;">Customer Details</h3>
                        <div class="form-grid">
                            <div class="form-group"><label for="orderNumber">Order Number</label><input type="number" id="orderNumber" required></div>
                            <div class="form-group"><label for="orderCustomerName">Customer Name</label><input type="text" id="orderCustomerName" required></div>
                            <div class="form-group"><label for="orderPhoneNumber">Phone Number</label><input type="tel" id="orderPhoneNumber" required></div>
                            <div class="form-group"><label for="city">City</label><input type="text" id="city"></div>
                            <div class="form-group"><label for="orderDate">Order Date</label><input type="date" id="orderDate"></div>
                            <div class="form-group"><label for="deliveryDate">Delivery Date</label><input type="date" id="deliveryDate"></div>
                            <div class="form-group"><label for="assignedTo">Overseen By</label><select id="assignedTo" required></select></div>
                        </div>
                        
                        <div class="form-group" style="margin-top:1.5rem;"><label for="specifications">Specifications / Notes</label><textarea id="specifications" rows="3"></textarea></div>
                        <div class="form-group" style="margin-top:1.5rem;"><label for="modifications">Modifications</label><textarea id="modifications" rows="3"></textarea></div>
                        <div class="form-group" style="margin-top:1.5rem;"><label for="itemPictures">Item Pictures</label><input type="file" id="itemPictures" accept="image/*" multiple></div>
                        
                        <div class="order-items-container">
                             <h3 style="color: var(--gold-secondary); margin-bottom: 1rem; border-bottom: 1px solid var(--gold-primary); padding-bottom: 0.5rem;">Order Items</h3>
                            <div id="orderItemsList"></div>
                            <div style="text-align: left; margin-top: 1rem;">
                                <button type="button" class="btn btn-secondary" onclick="orderApp.addOrderItemRow()"><i class="fas fa-plus"></i> Add Item</button>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 2rem;"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Order</button></div>
                    </form>
                </div>
            </div>

            <div id="order-order-tracking" class="tab-content">
                <h2 class="section-title">Track All Orders</h2>
                <div class="premium-card">
                    <div class="filter-grid">
                        <div class="form-group"><label>Search by Order #, Name, Phone</label><input type="text" id="orderSearchInput" oninput="orderApp.renderOrders()"></div>
                        <div class="form-group">
                            <label>Special Filters</label>
                            <select id="specialFilter" onchange="orderApp.renderOrders()">
                                <option value="all">All Active Orders</option>
                                <option value="overdue">Overdue Orders</option>
                                <option value="unassigned">Unassigned Worker</option>
                                <option value="completedNotDelivered">Ready for Delivery</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Filter by Staff</label>
                            <select id="staffFilter" onchange="orderApp.renderOrders()">
                                <option value="all">All Staff</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-container"><table class="premium-table"><thead id="orderTableHeader"></thead><tbody id="orderTableBody"></tbody></table></div>
            </div>
            
            <div id="order-dashboard" class="tab-content"><h2 class="section-title">Business Dashboard</h2><div class="analytics-dashboard" id="orderAnalyticsDashboard"><div class="analytics-card"><h3 id="totalOrders">0</h3><p>Total Orders Ever</p></div><div class="analytics-card"><h3 id="pendingOrders">0</h3><p>Pending</p></div><div class="analytics-card"><h3 id="inProgressOrders">0</h3><p>In Progress</p></div><div class="analytics-card"><h3 id="overdueCount">0</h3><p>Overdue</p></div><div class="analytics-card"><h3 id="deliveredCount">0</h3><p>Delivered</p></div></div><div class="premium-card"><h3 class="section-title" style="font-size: 1.8rem;">Orders by Worker</h3><div class="chart-container"><canvas id="workerChart"></canvas></div></div></div>
        </div>
        
        <div id="orderUpdateModal" class="modal-premium"><div class="modal-content">
            <h2 class="section-title" style="margin-bottom: 1.5rem;">Full Order Edit & History</h2>
            <div id="orderHistoryLog" style="max-height: 300px; overflow-y: auto; margin-bottom: 2rem;"></div>
            <form id="updateOrderForm"><input type="hidden" id="updateOrderId">
                <div id="updateOrderItemsList" class="form-grid" style="margin-bottom: 2rem;"></div>
                <div class="form-grid">
                    <div class="form-group"><label for="updateSpecifications">Specifications</label><textarea id="updateSpecifications" rows="3"></textarea></div>
                    <div class="form-group"><label for="updateModifications">Modifications</label><textarea id="updateModifications" rows="3"></textarea></div>
                </div>
                <div style="text-align: center; margin-top: 2rem;"><button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> Save Changes</button></div>
            </form>
            <div class="notes-section">
                <h3 style="color: var(--gold-primary); margin-bottom: 1.5rem; text-align: center;">Add Customer Communication Note</h3>
                <div class="form-group">
                    <label for="newCustomerNote">New Note</label>
                    <textarea id="newCustomerNote" rows="3" placeholder="Log a call or message with the customer..."></textarea>
                </div>
                <div style="text-align: center; margin-top: 1rem;">
                    <button type="button" id="addNoteBtn" class="btn btn-secondary"><i class="fas fa-plus"></i> Add Note to Log</button>
                </div>
            </div>
        </div></div>
        <div id="imageModal" class="modal-premium"><div class="modal-content"><div id="fullSizeImageContainer"></div></div></div>
    </div>

    <div id="staffPortal" class="app-portal">
         <div class="container">
            <header class="header">
                <div class="header-text"><h1>Staff Management</h1><p>Add and Remove Team Members</p></div>
                <div class="logo-container"><img src="logo.jpeg" alt="Logo" class="logo"></div>
                <button class="btn btn-secondary" onclick="showPortalSelection()"><i class="fas fa-home"></i> Main Menu</button>
            </header>
            <div class="tab-content active" style="padding-top: 2rem;">
                 <div class="premium-card">
                    <h2 class="section-title" style="font-size: 1.8rem;">Add New Staff Member</h2>
                    <form id="addStaffForm" style="display: flex; gap: 1rem; align-items: flex-end;">
                        <div class="form-group" style="flex-grow: 1;">
                            <label for="newStaffName">Staff Name</label>
                            <input type="text" id="newStaffName" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Add Staff</button>
                    </form>
                </div>
                 <div class="premium-card">
                    <h2 class="section-title" style="font-size: 1.8rem;">Current Staff</h2>
                    <div id="staffListContainer"></div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // === GLOBAL UTILITIES (Shared by all apps) ===
        function showNotification(message, isSuccess = true) {
            const notification = document.createElement('div');
            notification.className = 'premium-notification';
            notification.innerHTML = `<i class="fas fa-${isSuccess ? 'check-circle' : 'times-circle'}"></i> ${message}`;
            document.body.appendChild(notification);
            setTimeout(() => { if (notification.parentNode) notification.parentNode.removeChild(notification); }, 5000);
        }

        function toggleButtonLoading(button, isLoading, defaultButtonText = '') {
            if(button){ 
                button.disabled = isLoading; 
                if(isLoading) { 
                    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; 
                } else if (defaultButtonText) { 
                    button.innerHTML = defaultButtonText; 
                }
            }
        }

        function formatPhoneForWhatsApp(phone) { 
            let cleaned = (phone || '').replace(/\D/g, ''); 
            if (cleaned.length === 10) { cleaned = '91' + cleaned; } 
            return cleaned; 
        }

        // === PORTAL NAVIGATION ===
        const portalSelectionScreen = document.getElementById('portalSelectionScreen');
        const crmPortal = document.getElementById('crmPortal');
        const orderPortal = document.getElementById('orderPortal');
        const staffPortal = document.getElementById('staffPortal');
        
        let isCrmInitialized = false;
        let isOrderInitialized = false;
        let isStaffInitialized = false;

        function showPortal(portalName) {
            portalSelectionScreen.style.display = 'none';
            crmPortal.style.display = 'none';
            orderPortal.style.display = 'none';
            staffPortal.style.display = 'none';

            if (portalName === 'crm') {
                crmPortal.style.display = 'block';
                if (!isCrmInitialized) { crmApp.init(); isCrmInitialized = true; }
            } else if (portalName === 'order') {
                orderPortal.style.display = 'block';
                if (!isOrderInitialized) { orderApp.init(); isOrderInitialized = true; }
            } else if (portalName === 'staff') {
                staffPortal.style.display = 'block';
                if (!isStaffInitialized) { 
                    orderApp.initStaffPortal(); 
                    isStaffInitialized = true; 
                } else {
                    orderApp.renderStaffList();
                }
            }
        }

        function showPortalSelection() {
            crmPortal.style.display = 'none';
            orderPortal.style.display = 'none';
            staffPortal.style.display = 'none';
            portalSelectionScreen.style.display = 'flex';
        }

        // ===================================================================================
        // ================================ INSTA CRM APP ====================================
        // ===================================================================================
        const crmApp = {
            customers: [], dailyUpdates: [], charts: {}, modal: null,
            init() { this.modal = document.getElementById('crmUpdateModal'); this.showTab('add-customer', document.querySelector('#crmPortal .tab-button')); this.loadAllDataFromServer(); this.setupEventListeners(); },
            async handleApiRequest(endpoint, body, successMessage) { try { const response = await fetch(`/.netlify/functions/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) }); if (!response.ok) { const err = await response.json(); throw new Error(err.message || 'Server request failed'); } if(successMessage) showNotification(successMessage, true); return true; } catch (error) { showNotification(`Error: ${error.message}`, false); return false; } },
            async loadAllDataFromServer() { try { const response = await fetch('/.netlify/functions/get-all-data'); if (!response.ok) throw new Error('Server error!'); const data = await response.json(); this.customers = (data.customers || []).map(c => ({...c, id: c.id})); this.dailyUpdates = (data.dailyUpdates || []).map(u => ({...u, id: u.id})); this.customers.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded)); this.dailyUpdates.sort((a, b) => new Date(b.date) - new Date(a.date)); this.renderAll(); } catch (error) { showNotification("Could not load CRM data from the cloud.", false); } },
            setupEventListeners() { document.getElementById('customerForm').addEventListener('submit', (e) => this.handleAddCustomer(e)); document.getElementById('dailyUpdateForm').addEventListener('submit', (e) => this.handleAddDailyUpdate(e)); document.getElementById('updateForm').addEventListener('submit', (e) => this.handleUpdateCustomer(e)); document.getElementById('historySearchInput').addEventListener('input', (e) => this.handleHistorySearchInput(e)); document.getElementById('dailyUpdateCustomerSearch').addEventListener('input', (e) => this.handleDailyUpdateSearchInput(e)); this.modal.addEventListener('click', (e) => { if (e.target === this.modal) this.closeModal(); }); },
            async handleAddCustomer(e) { e.preventDefault(); const form = e.target; const button = form.querySelector('button[type="submit"]'); toggleButtonLoading(button, true, button.innerHTML); const newCustomer = { dateAdded: new Date().toISOString(), name: form.elements.customerName.value.trim(), phone: form.elements.phoneNumber.value.trim(), email: form.elements.email.value.trim(), location: form.elements.location.value.trim(), adSource: form.elements.adSource.value, interestedProduct: form.elements.interestedProduct.value.trim(), budget: form.elements.budget.value, leadStatus: form.elements.leadStatus.value, priority: form.elements.priority.value, nextFollowUp: form.elements.nextFollowUp.value, notes: [{ date: new Date().toISOString(), text: form.elements.initialResponse.value.trim() }] }; if (await this.handleApiRequest('add-customer', newCustomer, 'Customer saved!')) { form.reset(); await this.loadAllDataFromServer(); } toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Save Customer'); },
            async handleAddDailyUpdate(e) { e.preventDefault(); const form = e.target; const button = form.querySelector('button[type="submit"]'); toggleButtonLoading(button, true, button.innerHTML); const customerId = document.getElementById('dailyUpdateCustomerId').value; if (!customerId) { showNotification("Please select a valid customer from the list.", false); toggleButtonLoading(button, false, '<i class="fas fa-comment-medical"></i> Add Update'); return; } const newUpdate = { date: new Date().toISOString(), customerId: customerId, supportPerson: form.elements.supportPerson.value.trim(), interactionType: form.elements.callStatus.value, comment: form.elements.dailyComment.value.trim(), }; const customer = this.customers.find(c => c.id === newUpdate.customerId); if (customer) newUpdate.customerName = customer.name; if (await this.handleApiRequest('add-daily-update', newUpdate, 'Update saved!')) { form.reset(); document.getElementById('dailyUpdateCustomerId').value = ''; await this.loadAllDataFromServer(); } toggleButtonLoading(button, false, '<i class="fas fa-comment-medical"></i> Add Update'); },
            async handleUpdateCustomer(e) { e.preventDefault(); const form = e.target; const button = form.querySelector('button[type="submit"]'); toggleButtonLoading(button, true, button.innerHTML); const customerId = document.getElementById('updateCustomerIdModal').value; const updatedData = { name: document.getElementById('updateName').value.trim(), phone: document.getElementById('updatePhone').value.trim(), email: document.getElementById('updateEmail').value.trim(), location: document.getElementById('updateLocation').value.trim(), leadStatus: document.getElementById('updateStatus').value, priority: document.getElementById('updatePriority').value, nextFollowUp: document.getElementById('updateFollowUp').value, }; if (await this.handleApiRequest('update-customer', { id: customerId, data: updatedData }, 'Customer updated!')) { this.closeModal(); await this.loadAllDataFromServer(); } toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Update Customer'); },
            async handleDeleteCustomer(customerId) { if (!confirm('Are you sure you want to delete this customer? This cannot be undone.')) return; if (await this.handleApiRequest('delete-customer', { id: customerId }, 'Customer deleted.')) { await this.loadAllDataFromServer(); } },
            renderAll() { const filtered = this.getFilteredCustomers(); this.displayCustomers(filtered); this.displayDailyUpdates(); this.displayFollowUps(); this.populateDatalists(); this.updateAnalyticsDashboard(filtered); if (document.querySelector('#analytics.tab-content.active')) { this.renderCharts(filtered); } },
            getFilteredCustomers() { const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim(); const statusFilter = document.getElementById('statusFilter').value; const productFilter = document.getElementById('productFilter').value.toLowerCase().trim(); return this.customers.filter(customer => { const matchesSearch = !searchTerm ? true : (customer.name && customer.name.toLowerCase().includes(searchTerm)) || (customer.phone && customer.phone.includes(searchTerm)); const matchesStatus = !statusFilter ? true : customer.leadStatus === statusFilter; const matchesProduct = !productFilter ? true : (customer.interestedProduct && customer.interestedProduct.toLowerCase().includes(productFilter)); return matchesSearch && matchesStatus && matchesProduct; }); },
            displayCustomers(filteredCustomers) { const tableBody = document.getElementById('customerTableBody'); document.getElementById('customerTableHeader').innerHTML = `<tr><th>Customer</th><th>Contact</th><th>Interest</th><th>Status</th><th>Next Follow-up</th><th>Actions</th></tr>`; if (filteredCustomers.length === 0) { tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding: 2rem;">No customers match filters.</td></tr>'; return; } tableBody.innerHTML = filteredCustomers.map(cust => `<tr><td data-label="Customer"><strong>${cust.name}</strong><br><small>${cust.location || 'N/A'}</small></td><td data-label="Contact" class="contact-links"><a href="tel:${cust.phone}" class="phone-link"><i class="fas fa-phone"></i> Call</a><a href="https://wa.me/${formatPhoneForWhatsApp(cust.phone)}" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a></td><td data-label="Interest">${cust.interestedProduct || 'N/A'}</td><td data-label="Status">${cust.leadStatus}</td><td data-label="Next Follow-up">${cust.nextFollowUp || 'N/A'}</td><td data-label="Actions"><button class="btn btn-secondary" style="padding: 5px 10px;" onclick="crmApp.openUpdateModal('${cust.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-danger" style="padding: 5px 10px;" onclick="crmApp.handleDeleteCustomer('${cust.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join(''); },
            displayDailyUpdates() { const list = document.getElementById('dailyUpdatesList'); if (this.dailyUpdates.length === 0) { list.innerHTML = '<p style="text-align:center;">No recent updates.</p>'; return; } list.innerHTML = this.dailyUpdates.slice(0, 25).map(update => { const customer = this.customers.find(c => c.id === update.customerId); const customerName = update.customerName || (customer ? customer.name : 'Unknown'); const contactLinksHtml = customer ? `<div class="contact-links" style="justify-content: flex-start; margin-top: 0.5rem;"><a href="tel:${customer.phone}" class="phone-link"><i class="fas fa-phone"></i> Call</a><a href="https://wa.me/${formatPhoneForWhatsApp(customer.phone)}" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a></div>` : ''; return `<div style="border-left: 3px solid var(--gold-primary); padding-left: 1rem; margin-bottom: 1rem;"><div style="display: flex; justify-content: space-between;"><strong>${customerName}</strong><small>${new Date(update.date).toLocaleDateString()}</small></div><p><em>By: ${update.supportPerson} | ${update.interactionType}</em></p><p>${update.comment}</p>${contactLinksHtml}</div>`; }).join(''); },
            displayFollowUps() { const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0); const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999); const activeCustomers = this.customers.filter(c => c.leadStatus !== 'Converted' && c.leadStatus !== 'Not Interested'); const overdue = activeCustomers.filter(c => c.nextFollowUp && new Date(c.nextFollowUp) < todayStart); const today = activeCustomers.filter(c => c.nextFollowUp && new Date(c.nextFollowUp) >= todayStart && new Date(c.nextFollowUp) <= todayEnd); const upcoming = activeCustomers.filter(c => c.nextFollowUp && new Date(c.nextFollowUp) > todayEnd); const renderList = (custs, isOverdue = false) => { if (custs.length === 0) return `<p style="text-align: center;">None</p>`; return custs.map(c => `<div class="note-item"><div style="cursor:pointer;" onclick="crmApp.openUpdateModal('${c.id}')"><strong>${c.name}</strong><br><small>Due: ${new Date(c.nextFollowUp).toLocaleDateString()}</small></div><div class="contact-links" style="justify-content: flex-start; margin-top: 0.5rem;"><a href="tel:${c.phone}" class="phone-link"><i class="fas fa-phone"></i> Call</a><a href="https://wa.me/${formatPhoneForWhatsApp(c.phone)}" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i> WhatsApp</a></div></div>`).join(''); }; document.getElementById('overdueFollowUps').innerHTML = renderList(overdue, true); document.getElementById('todayFollowUps').innerHTML = renderList(today); document.getElementById('upcomingFollowUps').innerHTML = renderList(upcoming); },
            populateDatalists() { const productList = document.getElementById('productList'); const historyCustomerList = document.getElementById('historyCustomerList'); const dailyUpdateCustomerList = document.getElementById('dailyUpdateCustomerList'); if(!this.customers || this.customers.length === 0) return; const uniqueProducts = [...new Set(this.customers.map(c => c.interestedProduct).filter(p => p))]; productList.innerHTML = uniqueProducts.map(p => `<option value="${p}"></option>`).join(''); const customerOptions = this.customers.map(customer => `<option value="${customer.name} - ${customer.phone}" data-id="${customer.id}"></option>`).join(''); historyCustomerList.innerHTML = customerOptions; dailyUpdateCustomerList.innerHTML = customerOptions; },
            handleDailyUpdateSearchInput(event) { const value = event.target.value; const hiddenInput = document.getElementById('dailyUpdateCustomerId'); const options = document.getElementById('dailyUpdateCustomerList').options; hiddenInput.value = ''; for (let i = 0; i < options.length; i++) { if (options[i].value === value) { hiddenInput.value = options[i].getAttribute('data-id'); break; } } },
            handleHistorySearchInput(event) { const value = event.target.value; const options = document.getElementById('historyCustomerList').options; for (let i = 0; i < options.length; i++) { if (options[i].value === value) { this.displayFullCustomerHistory(options[i].getAttribute('data-id')); break; } } },
            searchAndDisplayHistory() { const value = document.getElementById('historySearchInput').value; const options = document.getElementById('historyCustomerList').options; let customerId = null; for (let i = 0; i < options.length; i++) { if (options[i].value === value) { customerId = options[i].getAttribute('data-id'); break; } } if (customerId) { this.displayFullCustomerHistory(customerId); } else { showNotification("Please select a valid customer.", false); } },
            displayFullCustomerHistory(customerId) { const container = document.getElementById('customerHistoryLog'); if (!customerId) { container.style.display = 'none'; return; } container.style.display = 'block'; const customer = this.customers.find(c => c.id === customerId); const customerUpdates = this.dailyUpdates.filter(u => u.customerId === customerId); const customerNotes = customer.notes || []; const history = [...customerUpdates, ...customerNotes].sort((a,b) => new Date(b.date) - new Date(a.date)); if (history.length === 0) { container.innerHTML = '<p>No history recorded.</p>'; return; } container.innerHTML = history.map(item => { const itemDate = new Date(item.date || item.timestamp).toLocaleString('en-IN'); if (item.text) { return `<div style="border-left: 3px solid #5bc0de; padding-left: 1rem; margin-bottom: 1rem;"><strong>Initial Note</strong> <small>(${itemDate})</small><p>${item.text}</p></div>`; } else { return `<div style="border-left: 3px solid var(--gold-primary); padding-left: 1rem; margin-bottom: 1rem;"><strong>Update by ${item.supportPerson}</strong> <small>(${itemDate})</small><p><em>Interaction: ${item.interactionType}</em></p><p>${item.comment}</p></div>`; } }).join(''); },
            updateAnalyticsDashboard(filteredCustomers) { const dataSet = filteredCustomers || this.customers; const total = dataSet.length; const converted = dataSet.filter(c => c.leadStatus === 'Converted').length; const today = new Date().toISOString().split('T')[0]; const todayUpdatesCount = this.dailyUpdates.filter(u => u.date.startsWith(today)).length; const pendingFollowUps = dataSet.filter(c => c.nextFollowUp && new Date(c.nextFollowUp) < new Date()).length; document.getElementById('totalLeads').textContent = total; document.getElementById('conversionRate').textContent = total > 0 ? `${Math.round((converted/total)*100)}%` : '0%'; document.getElementById('todayUpdates').textContent = todayUpdatesCount; document.getElementById('followUpPending').textContent = pendingFollowUps; const sourceCounts = dataSet.reduce((acc, c) => { if (c.adSource) { acc[c.adSource] = (acc[c.adSource] || 0) + 1; } return acc; }, {}); const sourceDashboard = document.getElementById('sourceCountDashboard'); sourceDashboard.innerHTML = Object.keys(sourceCounts).map(source => `<div class="analytics-card"><h4>${sourceCounts[source]}</h4><p>${source}</p></div>`).join(''); },
            renderCharts(filteredCustomers) { const dataSet = filteredCustomers || this.customers; Object.values(this.charts).forEach(chart => { if (chart.destroy) chart.destroy(); }); const chartLabelColor = '#AAAAAA'; const statusCounts = dataSet.reduce((acc, c) => { acc[c.leadStatus] = (acc[c.leadStatus] || 0) + 1; return acc; }, {}); this.charts.status = new Chart(document.getElementById('statusChart').getContext('2d'), { type: 'doughnut', data: { labels: Object.keys(statusCounts), datasets: [{ data: Object.values(statusCounts), backgroundColor: ['#DCCA87', '#5bc0de', '#5cb85c', '#f0ad4e', '#d9534f', '#8a6de9'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: chartLabelColor } } } } }); const sourceCounts = dataSet.reduce((acc, c) => { acc[c.adSource] = (acc[c.adSource] || 0) + 1; return acc; }, {}); this.charts.source = new Chart(document.getElementById('sourceChart').getContext('2d'), { type: 'pie', data: { labels: Object.keys(sourceCounts), datasets: [{ data: Object.values(sourceCounts), backgroundColor: ['#DCCA87', '#AAAAAA', '#F5EFE1', '#5bc0de', '#5cb85c'] }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: chartLabelColor } } } } }); },
            showTab(tabName, element) { document.querySelectorAll('#crmPortal .tab-content').forEach(c => c.classList.remove('active')); document.querySelectorAll('#crmPortal .tab-button').forEach(b => b.classList.remove('active')); document.getElementById(tabName).classList.add('active'); element.classList.add('active'); if (tabName !== 'add-customer') { this.renderAll(); } },
            openUpdateModal(customerId) { const customer = this.customers.find(c => c.id === customerId); if (!customer) return; const form = document.getElementById('updateForm'); form.elements.updateCustomerIdModal.value = customer.id; form.elements.updateName.value = customer.name; form.elements.updatePhone.value = customer.phone; form.elements.updateEmail.value = customer.email || ''; form.elements.updateLocation.value = customer.location || ''; form.elements.updateStatus.value = customer.leadStatus; form.elements.updatePriority.value = customer.priority; form.elements.updateFollowUp.value = customer.nextFollowUp || ''; this.displayCustomerHistoryInModal(customerId); this.modal.classList.add('show'); },
            displayCustomerHistoryInModal(customerId) { const container = document.getElementById('customerUpdateHistory'); const customer = this.customers.find(c => c.id === customerId); const customerUpdates = this.dailyUpdates.filter(u => u.customerId === customerId); const customerNotes = customer.notes || []; const history = [...customerUpdates, ...customerNotes].sort((a,b) => new Date(b.date) - new Date(a.date)); if (history.length === 0) { container.innerHTML = '<p>No history for this customer.</p>'; return; } container.innerHTML = history.slice(0, 5).map(item => { const itemDate = new Date(item.date || item.timestamp).toLocaleString('en-IN'); if (item.text) { return `<div style="border-left: 3px solid #5bc0de; padding-left: 1rem; margin-bottom: 1rem;"><strong>Initial Note</strong> <small>(${itemDate})</small><p>${item.text}</p></div>`; } else { return `<div style="border-left: 3px solid var(--gold-primary); padding-left: 1rem; margin-bottom: 1rem;"><strong>Update by ${item.supportPerson}</strong> <small>(${itemDate})</small><p>${item.comment}</p></div>`; } }).join(''); },
            closeModal() { this.modal.classList.remove('show'); }
        };

        // ===================================================================================
        // ======================= ORDER MANAGEMENT & STAFF APP ==============================
        // ===================================================================================
        const orderApp = {
            orders: [], archivedOrders: [], staff: [], charts: {},

            init() {
                this.showTab('new-order', document.querySelector('#orderPortal .tab-button'));
                this.loadAllDataFromServer();
                this.setupEventListeners();
            },

            initStaffPortal() {
                if (this.staff.length === 0 && this.orders.length === 0) { this.loadAllDataFromServer(); } 
                else { this.renderStaffList(); }
                document.getElementById('addStaffForm').addEventListener('submit', (e) => this.handleAddStaff(e));
            },

            async handleApiRequest(endpoint, body, successMessage) { return crmApp.handleApiRequest(endpoint, body, successMessage); },
            
            async loadAllDataFromServer() {
                try {
                    const response = await fetch('/.netlify/functions/get-order-data');
                    if (!response.ok) throw new Error(`Server error: ${response.statusText}`);
                    const data = await response.json();
                    
                    let loadedOrders = (data.orders || []).map(o => ({...o, id: o.id }));
                    
                    loadedOrders.forEach(order => {
                        if (!order.items && order.itemName) {
                            order.items = [{
                                name: order.itemName,
                                weight: order.weight || '',
                                workerName: order.workerName || 'Unassigned',
                                status: order.status || 'Pending' 
                            }];
                        }
                    });

                    this.orders = loadedOrders;
                    this.archivedOrders = (data.archivedOrders || []).map(o => ({...o, id: o.id }));
                    this.staff = (data.staff || []).map(s => ({...s, id: s.id }));
                    this.orders.sort((a, b) => b.orderNumber - a.orderNumber);
                    
                    this.renderAll(); 
                    this.renderStaffList();

                } catch(error) { showNotification(`Could not load Order data. ${error.message}`, false); console.error(error); }
            },
            
            renderAll() {
                this.renderOrders();
                this.populateDatalistsAndFilters();
                this.updateDashboard();
                if (document.querySelector('#order-dashboard.tab-content.active')) { this.renderCharts(); }
            },
            
            populateDatalistsAndFilters() {
                const allKnownOrders = [...this.orders, ...this.archivedOrders];
                const workerDatalist = document.querySelector('#order-new-order [list="workerDatalist"]');
                const uniqueWorkers = [...new Set(allKnownOrders.flatMap(o => (o.items || []).map(i => i.workerName)).filter(Boolean))];
                if(workerDatalist) {
                    const datalist = document.getElementById('workerDatalist') || document.createElement('datalist');
                    datalist.id = 'workerDatalist';
                    datalist.innerHTML = uniqueWorkers.map(name => `<option value="${name}"></option>`).join('');
                    document.body.appendChild(datalist);
                }

                const staffFilter = document.getElementById('staffFilter');
                const assignedToSelect = document.getElementById('assignedTo');
                const staffOptions = this.staff.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
                
                if(staffFilter) staffFilter.innerHTML = `<option value="all">All Staff</option>${staffOptions}`;
                if(assignedToSelect) assignedToSelect.innerHTML = staffOptions;
            },

            showTab(tabName, element) {
                document.querySelectorAll('#orderPortal .tab-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('#orderPortal .tab-button').forEach(b => b.classList.remove('active'));
                document.getElementById(`order-${tabName}`).classList.add('active');
                element.classList.add('active');
                this.renderAll();
            },

            setupEventListeners() {
                document.getElementById('newOrderForm').addEventListener('submit', (e) => this.handleAddOrder(e));
                document.getElementById('updateOrderForm').addEventListener('submit', (e) => this.handleUpdateOrder(e));
                document.getElementById('addNoteBtn').addEventListener('click', () => this.handleAddOrderLogNote());
                document.getElementById('orderUpdateModal').addEventListener('click', (e) => { if (e.target.id === 'orderUpdateModal') this.closeModal('orderUpdateModal'); });
                document.getElementById('imageModal').addEventListener('click', () => this.closeModal('imageModal'));
            },

            addOrderItemRow() {
                const container = document.getElementById('orderItemsList');
                const itemId = `item_${Date.now()}`;
                const itemHtml = `
                    <div class="order-item-row" id="${itemId}">
                        <button type="button" class="remove-item-btn" onclick="orderApp.removeOrderItemRow('${itemId}')">&times;</button>
                        <div class="form-group"><label>Item Name</label><input type="text" class="item-name" required></div>
                        <div class="form-group"><label>Weight (g)</label><input type="text" class="item-weight"></div>
                        <div class="form-group"><label>Worker</label><input type="text" class="item-worker" list="workerDatalist"></div>
                        <div class="form-group">
                            <label>Item Status</label>
                            <select class="item-status">
                                <option value="Pending">Pending</option>
                                <option value="In-Progress">In-Progress</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', itemHtml);
            },

            removeOrderItemRow(itemId) {
                document.getElementById(itemId)?.remove();
            },

            async handleAddOrder(e) {
                e.preventDefault();
                const form = e.target;
                const button = form.querySelector('button[type="submit"]');
                toggleButtonLoading(button, true, button.innerHTML);
                
                const items = [];
                document.querySelectorAll('#orderItemsList .order-item-row').forEach(row => {
                    items.push({
                        name: row.querySelector('.item-name').value,
                        weight: row.querySelector('.item-weight').value,
                        workerName: row.querySelector('.item-worker').value,
                        status: row.querySelector('.item-status').value,
                    });
                });

                if (items.length === 0) {
                    showNotification("Please add at least one item to the order.", false);
                    toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Save Order');
                    return;
                }

                const imageFiles = form.elements.itemPictures.files;
                let itemPictureUrls = [];
                if (imageFiles.length > 0) {
                    const base64Promises = Array.from(imageFiles).map(file => this.fileToBase64(file));
                    try {
                        itemPictureUrls = await Promise.all(base64Promises);
                    } catch (error) {
                        showNotification("Could not process one or more images.", false);
                        toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Save Order');
                        return;
                    }
                }

                const newOrder = {
                    orderNumber: parseInt(form.elements.orderNumber.value),
                    customerName: form.elements.orderCustomerName.value.trim(),
                    phoneNumber: form.elements.orderPhoneNumber.value.trim(),
                    city: form.elements.city.value.trim(),
                    orderDate: form.elements.orderDate.value || new Date().toISOString().split('T')[0],
                    deliveryDate: form.elements.deliveryDate.value,
                    assignedTo: form.elements.assignedTo.value,
                    specifications: form.elements.specifications.value.trim(),
                    modifications: form.elements.modifications.value.trim(),
                    itemPictureUrls: itemPictureUrls,
                    status: 'Pending',
                    historyLog: [{
                        timestamp: new Date().toISOString(),
                        type: 'Creation',
                        text: `Order created with ${items.length} item(s) and assigned to ${form.elements.assignedTo.value}.`
                    }],
                    dateAdded: new Date().toISOString(),
                    items: items
                };

                if (await this.handleApiRequest('add-order', newOrder, 'Order saved successfully!')) {
                    form.reset();
                    document.getElementById('orderItemsList').innerHTML = '';
                    await this.loadAllDataFromServer();
                    this.showTab('order-tracking', document.querySelector('#orderPortal button[onclick*="order-tracking"]'));
                }
                toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Save Order');
            },
            
            renderOrders() {
                const tableBody = document.getElementById('orderTableBody');
                document.getElementById('orderTableHeader').innerHTML = `<tr><th>Image</th><th>Order #</th><th>Customer</th><th>Contact</th><th>Delivery Date</th><th>Overseen By</th><th>Actions</th></tr>`;
                
                const searchTerm = document.getElementById('orderSearchInput').value.toLowerCase();
                const specialFilter = document.getElementById('specialFilter').value;
                const staffFilter = document.getElementById('staffFilter').value;
                const today = new Date(); today.setHours(0, 0, 0, 0);

                let filteredOrders = this.orders.filter(o => {
                    if (o.status === 'Delivered') return false; // Always hide delivered orders from active view

                    const matchesSearch = !searchTerm || o.orderNumber.toString().includes(searchTerm) || o.customerName.toLowerCase().includes(searchTerm) || o.phoneNumber.includes(searchTerm);
                    const matchesStaff = staffFilter === 'all' || o.assignedTo === staffFilter;
                    
                    let matchesSpecial = false;
                    if (specialFilter === 'all') { matchesSpecial = true;
                    } else if (specialFilter === 'overdue') { matchesSpecial = o.deliveryDate && new Date(o.deliveryDate) < today && o.status !== 'Delivered';
                    } else if (specialFilter === 'unassigned') { matchesSpecial = (o.items || []).some(item => !item.workerName);
                    } else if (specialFilter === 'completedNotDelivered') {  matchesSpecial = o.status === 'Completed';}
                    
                    return matchesSearch && matchesStaff && matchesSpecial;
                });

                if (filteredOrders.length === 0) { tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 2rem;">No orders match filters.</td></tr>`; return; }

                let tableHtml = '';
                filteredOrders.forEach(order => {
                    const isOverdue = order.deliveryDate && new Date(order.deliveryDate) < today && order.status !== 'Delivered';
                    const dateHtml = order.deliveryDate ? `${new Date(order.deliveryDate).toLocaleDateString('en-IN')} ${isOverdue ? '<i class="fas fa-exclamation-triangle" style="color: var(--danger-red);"></i>' : ''}` : 'N/A';
                    const imageHtml = order.itemPictureUrls && order.itemPictureUrls.length > 0
                        ? `<img src="${order.itemPictureUrls[0]}" class="order-image-thumbnail" onclick="orderApp.openImageModal('${order.id}')">`
                        : `<span>No Image</span>`;
                    const staffOptions = this.staff.map(s => `<option value="${s.name}" ${order.assignedTo === s.name ? 'selected' : ''}>${s.name}</option>`).join('');

                    tableHtml += `
                    <tr id="order-row-${order.id}">
                        <td data-label="Image">${imageHtml}</td>
                        <td data-label="Order #">${order.orderNumber}</td>
                        <td data-label="Customer"><strong>${order.customerName}</strong><br><small>${order.city || 'N/A'}</small></td>
                        <td data-label="Contact" class="contact-links"><a href="tel:${order.phoneNumber}" class="phone-link"><i class="fas fa-phone"></i></a><a href="https://wa.me/${formatPhoneForWhatsApp(order.phoneNumber)}" class="whatsapp-link" target="_blank"><i class="fab fa-whatsapp"></i></a></td>
                        <td data-label="Delivery Date">${dateHtml}</td>
                        <td data-label="Overseen By">${order.assignedTo || 'N/A'}</td>
                        <td data-label="Actions"><button class="btn btn-primary" style="padding: 5px 10px;" onclick="orderApp.toggleItemDetails('${order.id}')"><i class="fas fa-edit"></i></button></td>
                    </tr>
                    <tr class="details-row" id="details-row-${order.id}"><td colspan="7">
                        <div class="details-content">
                            <div class="form-group" style="max-width: 300px; margin-bottom: 1.5rem;">
                                <label>Change "Overseen By"</label>
                                <select class="assigned-staff-select">${staffOptions}</select>
                            </div>
                            <h4>Item Details</h4>
                            ${(order.items || []).length > 0 ? (order.items || []).map((item, index) => `
                                <div class="inline-item-update">
                                    <strong>${item.name} (${item.weight}g)</strong>
                                    <input type="text" class="inline-item-worker" value="${item.workerName || ''}" placeholder="Assign Worker..." list="workerDatalist">
                                    <select class="inline-item-status">
                                        <option value="Pending" ${item.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                        <option value="In-Progress" ${item.status === 'In-Progress' ? 'selected' : ''}>In-Progress</option>
                                        <option value="Completed" ${item.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                        <option value="Delivered" ${item.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                    </select>
                                </div>
                            `).join('') : '<p>No items found for this order.</p>'}
                            <div class="details-buttons">
                                <button class="btn btn-secondary" onclick="orderApp.openUpdateModal('${order.id}')">Full Edit & Log</button>
                                <button class="btn btn-primary" data-order-id="${order.id}" onclick="orderApp.handleInlineUpdate(this)">Save Changes</button>
                            </div>
                        </div>
                    </td></tr>`;
                });
                tableBody.innerHTML = tableHtml;
            },
            
            toggleItemDetails(orderId) {
                document.getElementById(`details-row-${orderId}`).classList.toggle('show');
            },

            async handleInlineUpdate(button) {
                const orderId = button.dataset.orderId;
                const order = this.orders.find(o => o.id === orderId);
                if (!order) return showNotification("Order not found.", false);

                toggleButtonLoading(button, true, button.innerHTML);

                const detailsRow = document.getElementById(`details-row-${orderId}`);
                const newAssignedTo = detailsRow.querySelector('.assigned-staff-select').value;
                
                const newLogEntries = [];
                const updatedItems = [];

                if (order.assignedTo !== newAssignedTo) {
                    newLogEntries.push({ timestamp: new Date().toISOString(), type: 'Assignment', text: `Overseen by changed from ${order.assignedTo || 'N/A'} to ${newAssignedTo}.` });
                }

                detailsRow.querySelectorAll('.inline-item-update').forEach((itemRow, index) => {
                    const originalItem = order.items[index];
                    const updatedItem = {
                        ...originalItem,
                        workerName: itemRow.querySelector('.inline-item-worker').value.trim(),
                        status: itemRow.querySelector('.inline-item-status').value
                    };
                    updatedItems.push(updatedItem);

                    if (originalItem.status !== updatedItem.status) {
                        newLogEntries.push({ timestamp: new Date().toISOString(), type: 'Status Change', text: `Item '${updatedItem.name}' status changed to ${updatedItem.status}.` });
                    }
                    if (originalItem.workerName !== updatedItem.workerName) {
                        newLogEntries.push({ timestamp: new Date().toISOString(), type: 'Assignment', text: `Item '${updatedItem.name}' assigned to worker ${updatedItem.workerName || 'Unassigned'}.` });
                    }
                });
                
                const allItemsDelivered = updatedItems.length > 0 && updatedItems.every(item => item.status === 'Delivered');
                let mainStatus = order.status;
                if (allItemsDelivered) mainStatus = 'Delivered';
                
                const finalLog = [...(order.historyLog || []), ...newLogEntries];
                const updates = { assignedTo: newAssignedTo, items: updatedItems, status: mainStatus, historyLog: finalLog };
                
                if (mainStatus === 'Delivered') {
                    if (await this.handleApiRequest('archive-order', { id: orderId, orderData: { ...order, ...updates } }, 'Order Delivered & Archived!')) {
                        this.orders = this.orders.filter(o => o.id !== orderId);
                        this.archivedOrders.push({ ...order, ...updates });
                        this.renderAll();
                    }
                } else {
                    if (await this.handleApiRequest('update-order', { id: orderId, updates }, 'Order updated!')) {
                        order.assignedTo = newAssignedTo;
                        order.items = updatedItems;
                        order.status = mainStatus;
                        order.historyLog = finalLog;
                        this.renderOrders();
                    }
                }
                toggleButtonLoading(button, false, 'Save Changes');
            },

            async handleUpdateOrder(e) {
                e.preventDefault();
                const button = e.target.querySelector('button[type="submit"]');
                toggleButtonLoading(button, true, button.innerHTML);
                const orderId = document.getElementById('updateOrderId').value;
                const order = this.orders.find(o => o.id === orderId);
                
                const updatedItems = [];
                document.querySelectorAll('#updateOrderItemsList .order-item-row').forEach(row => {
                    updatedItems.push({
                        name: row.dataset.name, weight: row.dataset.weight,
                        workerName: row.querySelector('.update-item-worker').value, status: row.querySelector('.update-item-status').value
                    });
                });
                
                const allItemsDelivered = updatedItems.length > 0 && updatedItems.every(item => item.status === 'Delivered');
                const allItemsCompleted = updatedItems.every(item => item.status === 'Completed' || item.status === 'Delivered');

                let mainStatus = 'Pending';
                if(allItemsDelivered) mainStatus = 'Delivered';
                else if (allItemsCompleted) mainStatus = 'Completed';
                else if (updatedItems.some(i => i.status !== 'Pending')) mainStatus = 'In-Progress';

                const updates = {
                    items: updatedItems,
                    specifications: document.getElementById('updateSpecifications').value.trim(),
                    modifications: document.getElementById('updateModifications').value.trim(),
                    status: mainStatus,
                };
                // Note: Log entries for these changes are not added here to keep the modal simple.
                // Complex changes are expected to be logged via inline edits or notes.
                
                if (mainStatus === 'Delivered') {
                     if (await this.handleApiRequest('archive-order', { id: orderId, orderData: { ...order, ...updates } }, 'Order Delivered & Archived!')) {
                        this.orders = this.orders.filter(o => o.id !== orderId);
                        this.archivedOrders.push({ ...order, ...updates });
                        this.closeModal('orderUpdateModal');
                        this.renderAll();
                    }
                } else {
                    if (await this.handleApiRequest('update-order', { id: orderId, updates }, 'Order updated!')) {
                        this.closeModal('orderUpdateModal');
                        await this.loadAllDataFromServer();
                    }
                }
                toggleButtonLoading(button, false, '<i class="fas fa-save"></i> Save Changes');
            },

            async handleAddOrderLogNote() {
                const orderId = document.getElementById('updateOrderId').value;
                const order = this.orders.find(o => o.id === orderId);
                const noteText = document.getElementById('newCustomerNote').value.trim();
                if (!noteText) return showNotification("Note cannot be empty.", false);

                const newLogEntry = {
                    timestamp: new Date().toISOString(),
                    type: 'Note',
                    text: noteText
                };

                const updatedLog = [...(order.historyLog || []), newLogEntry];
                const updates = { historyLog: updatedLog };

                if (await this.handleApiRequest('update-order', { id: orderId, updates }, 'Note added to log!')) {
                    document.getElementById('newCustomerNote').value = '';
                    order.historyLog = updatedLog; // Update local state
                    this.renderOrderHistoryLog(order.historyLog);
                }
            },

            openUpdateModal(orderId) {
                const order = this.orders.find(o => o.id === orderId);
                if (!order) return;
                document.getElementById('updateOrderId').value = order.id;
                document.getElementById('updateSpecifications').value = order.specifications || '';
                document.getElementById('updateModifications').value = order.modifications || '';

                const itemsContainer = document.getElementById('updateOrderItemsList');
                const items = order.items || [];
                itemsContainer.innerHTML = items.map(item => `
                    <div class="order-item-row" data-name="${item.name}" data-weight="${item.weight}">
                        <div class="form-group">
                            <label>${item.name} (${item.weight}g)</label>
                            <input type="text" class="update-item-worker" value="${item.workerName || ''}" placeholder="Assign Worker..." list="workerDatalist">
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select class="update-item-status">
                                <option value="Pending" ${item.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="In-Progress" ${item.status === 'In-Progress' ? 'selected' : ''}>In-Progress</option>
                                <option value="Completed" ${item.status === 'Completed' ? 'selected' : ''}>Completed</option>
                                <option value="Delivered" ${item.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                            </select>
                        </div>
                    </div>
                `).join('');
                
                this.renderOrderHistoryLog(order.historyLog || []);
                document.getElementById('newCustomerNote').value = '';
                document.getElementById('orderUpdateModal').classList.add('show');
            },

            renderOrderHistoryLog(log) {
                const container = document.getElementById('orderHistoryLog');
                if (!log || log.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">No history recorded for this order.</p>';
                    return;
                }
                const sortedLog = [...log].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                container.innerHTML = sortedLog.map(entry => {
                    const date = new Date(entry.timestamp).toLocaleString('en-IN');
                    let icon = 'fa-info-circle';
                    if (entry.type === 'Status Change') icon = 'fa-check-circle';
                    if (entry.type === 'Assignment') icon = 'fa-user-tag';
                    if (entry.type === 'Note') icon = 'fa-comment-alt';
                    if (entry.type === 'Creation') icon = 'fa-star';
                    return `
                        <div class="note-item">
                            <p><i class="fas ${icon}" style="margin-right: 8px; color: var(--gold-primary);"></i>${entry.text}</p>
                            <small>${date}</small>
                        </div>
                    `;
                }).join('');
            },

            renderCharts() { 
                if (this.charts.worker) this.charts.worker.destroy(); 
                const allKnownOrders = [...this.orders, ...this.archivedOrders]; 
                const workerCounts = allKnownOrders.reduce((acc, order) => { 
                    (order.items || []).forEach(item => {
                        const worker = item.workerName || 'Unassigned'; 
                        acc[worker] = (acc[worker] || 0) + 1; 
                    }); return acc; 
                }, {}); 
                if(document.getElementById('workerChart')) {
                    this.charts.worker = new Chart(document.getElementById('workerChart').getContext('2d'), { type: 'bar', data: { labels: Object.keys(workerCounts), datasets: [{ label: 'Number of Items Assigned', data: Object.values(workerCounts), backgroundColor: '#DCCA87' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#AAAAAA', stepSize: 1 } }, x: { ticks: { color: '#AAAAAA' } } }, plugins: { legend: { display: false } } } }); 
                }
            },

            renderStaffList() {
                const container = document.getElementById('staffListContainer');
                if(!container) return;
                if (this.staff.length === 0) {
                    container.innerHTML = '<p style="text-align:center;">No staff members added yet.</p>';
                    return;
                }
                container.innerHTML = this.staff.map(s => `
                    <div class="staff-list-item">
                        <span>${s.name}</span>
                        <button class="btn btn-danger" style="padding: 5px 10px;" onclick="orderApp.handleDeleteStaff('${s.id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            },

            async handleAddStaff(e) {
                e.preventDefault();
                const input = document.getElementById('newStaffName');
                const name = input.value.trim();
                if (!name) return showNotification("Staff name cannot be empty.", false);
                
                if (await this.handleApiRequest('add-staff', { name }, 'Staff member added!')) {
                    input.value = '';
                    await this.loadAllDataFromServer();
                }
            },

            async handleDeleteStaff(staffId) {
                if (!confirm('Are you sure you want to delete this staff member?')) return;
                if (await this.handleApiRequest('delete-staff', { id: staffId }, 'Staff member deleted.')) {
                    await this.loadAllDataFromServer();
                }
            },

            fileToBase64(file) { return new Promise((resolve, reject) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = () => resolve(reader.result); reader.onerror = error => reject(error); }); },
                        
            updateDashboard() { const totalActiveOrders = this.orders.length; const pending = this.orders.filter(o => o.status === 'Pending').length; const inProgress = this.orders.filter(o => o.status === 'In-Progress').length; const overdue = this.orders.filter(o => o.deliveryDate && new Date(o.deliveryDate) < new Date() && o.status !== 'Delivered').length; const dashboard = document.getElementById('orderAnalyticsDashboard'); if(!dashboard) return; dashboard.querySelector('#totalOrders').textContent = totalActiveOrders + this.archivedOrders.length; dashboard.querySelector('#pendingOrders').textContent = pending; dashboard.querySelector('#inProgressOrders').textContent = inProgress; dashboard.querySelector('#overdueCount').textContent = overdue; dashboard.querySelector('#deliveredCount').textContent = this.archivedOrders.length; },
                        
            openImageModal(orderId) { 
                const order = this.orders.find(o => o.id === orderId); 
                const imageUrls = (order.itemPictureUrls && order.itemPictureUrls.length > 0) ? order.itemPictureUrls : (order.itemPictureUrl ? [order.itemPictureUrl] : []);
                if (imageUrls.length > 0) {
                    const container = document.getElementById('fullSizeImageContainer');
                    container.innerHTML = imageUrls.map(url => `<img src="${url}" alt="Full Size Order Image">`).join('');
                    document.getElementById('imageModal').classList.add('show');
                }
            },
            
            closeModal(modalId) { const modal = document.getElementById(modalId); if (modal) modal.classList.remove('show'); }
        };
    </script>
</body>
</html>
